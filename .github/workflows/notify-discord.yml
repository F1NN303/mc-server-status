name: Notify Discord on status change

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # alle 5 Minuten

permissions:
  contents: write

concurrency:
  group: bedrock-status
  cancel-in-progress: true

env:
  API_URL: https://mc-server-status-black.vercel.app/api/bedrock
  STATUS_DIR: .status

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: Install jq & curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Ensure cache dir
        run: mkdir -p "$STATUS_DIR"

      - name: Fetch live status
        id: fetch
        shell: bash
        run: |
          set -euo pipefail

          # 1) Live abrufen (bei Fehler leeres JSON)
          if ! curl -fsSL "$API_URL" -o "$STATUS_DIR/live_raw.json"; then
            echo '{}' > "$STATUS_DIR/live_raw.json"
          fi

          # 2) JSON validieren, sonst leeres JSON
          if ! jq -e . "$STATUS_DIR/live_raw.json" >/dev/null 2>&1; then
            echo '{}' > "$STATUS_DIR/live_raw.json"
          fi

          # 3) Robust normalisieren (FIX: Datum erst parsen, dann strftime)
          jq -r '
            def ts:
              (.lastChanged // .updatedAt // .timestamp // now)
              | (if type=="string" then fromdateiso8601? else . end)
              // now;

            {
              online:      (.online // false),
              version:     (.version // .bedrockVersion // ""),
              motd:        (.motd // .serverName // ""),
              players: {
                online: (.players.online // .playersOnline // 0),
                max:    (.players.max    // .playersMax    // 0),
                sample: (.players.sample // [])
              },
              checked_at_unix: (ts | floor),
              checked_at_iso:  (ts | strftime("%Y-%m-%d %H:%M:%S UTC"))
            }
          ' "$STATUS_DIR/live_raw.json" > "$STATUS_DIR/live.json"

          # 4) Fingerprint fÃ¼r Ã„nderungsdetektion
          printf '%s\t%s\t%s\n' \
            "$(jq -r '.online'          "$STATUS_DIR/live.json")" \
            "$(jq -r '.players.online'  "$STATUS_DIR/live.json")" \
            "$(jq -r '.version'         "$STATUS_DIR/live.json")" \
            > "$STATUS_DIR/live.fingerprint"

          if [ -f "$STATUS_DIR/prev.fingerprint" ]; then
            if cmp -s "$STATUS_DIR/live.fingerprint" "$STATUS_DIR/prev.fingerprint"; then
              echo "changed=0" >> "$GITHUB_OUTPUT"
            else
              echo "changed=1" >> "$GITHUB_OUTPUT"
            fi
          else
            # Erster Lauf -> einmal benachrichtigen
            echo "changed=1" >> "$GITHUB_OUTPUT"
          fi

      - name: Load previous status (if any)
        if: steps.fetch.outputs.changed == '1'
        run: test -f "$STATUS_DIR/prev.json" || echo '{}' > "$STATUS_DIR/prev.json"

      - name: Check change and (optionally) notify Discord
        if: steps.fetch.outputs.changed == '1'
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: bash
        run: |
          set -euo pipefail

          ONLINE=$(jq -r '.online' "$STATUS_DIR/live.json")
          PLAYERS=$(jq -r '.players.online' "$STATUS_DIR/live.json")
          VERSION=$(jq -r '.version' "$STATUS_DIR/live.json")
          CHECKED=$(jq -r '.checked_at_iso' "$STATUS_DIR/live.json")
          COLOR=$([ "$ONLINE" = "true" ] && echo 3066993 || echo 15158332)

          # Discord-Embed erzeugen (timestamp im Embed = jetzt)
          jq -n --arg online "$ONLINE" \
                --arg players "$PLAYERS" \
                --arg version "$VERSION" \
                --arg checked "$CHECKED" \
                --argjson color "$COLOR" '
            {
              embeds: [{
                title: "Bedrock Server Status",
                description: (if $online=="true" then "ðŸŸ¢ **ONLINE**" else "ðŸ”´ **OFFLINE**" end),
                color: $color,
                fields: [
                  {name:"Players", value: ($players + " online"), inline:true},
                  {name:"Version", value: $version, inline:true},
                  {name:"Checked", value: $checked, inline:true}
                ],
                timestamp: (now | todate)
              }]
            }
          ' > payload.json

          if [ -n "${WEBHOOK_URL:-}" ]; then
            curl -fsSL -H "Content-Type: application/json" -d @payload.json "$WEBHOOK_URL"
          else
            echo "WARN: Kein DISCORD_WEBHOOK_URL Secret gesetzt â€“ Ã¼berspringe Notify."
          fi

      - name: Update cache file (commit only if changed)
        if: steps.fetch.outputs.changed == '1'
        shell: bash
        run: |
          set -euo pipefail
          cp "$STATUS_DIR/live.json"        "$STATUS_DIR/prev.json"
          cp "$STATUS_DIR/live.fingerprint" "$STATUS_DIR/prev.fingerprint"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$STATUS_DIR/prev.json" "$STATUS_DIR/prev.fingerprint"
          git commit -m "chore(status): update bedrock status [skip ci]" || exit 0
          git push