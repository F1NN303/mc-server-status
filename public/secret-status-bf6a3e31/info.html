<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Server-Informationen</title>
  <style>
    :root{
      --bg:#0b0d11; --panel:#101522; --line:#1b2231;
      --muted:#6e7eb0; --good:#19c37d; --warn:#f0a019; --bad:#ef4444; --u:#95a3b6;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:#e6ebff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    .wrap{max-width:1000px;margin:28px auto;padding:0 16px}
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:18px}
    h1{margin:0;font-size:26px}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,var(--panel),#0b0f1a);color:var(--u);cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .card{background:linear-gradient(180deg,var(--panel),#0c111c);border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:18px;box-shadow:inset 0 0 1px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px 0;font-size:20px}
    .muted{color:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (min-width:680px){ .kpis{grid-template-columns:repeat(4,minmax(0,1fr))} }
    .kpi{border:1px solid var(--line);border-radius:10px;padding:12px 12px}
    .kpi strong{display:block;font-size:13px;color:var(--u);font-weight:600;margin-bottom:6px}
    .kpi .val{font-weight:700;font-size:20px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.02);font-size:13px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;background:#666}
    .dot.ok{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .list{border:1px solid var(--line);border-radius:10px;padding:10px;min-height:42px;background:rgba(255,255,255,.02)}
    .error{color:#ff6b6b;font-weight:600}
    .src{display:inline-block;margin-left:8px;padding:4px 8px;border-radius:8px;border:1px solid var(--line);color:var(--muted);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }

    /* Mini-Chart */
    .chartbox{position:relative;height:200px;border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.02);overflow:hidden}
    canvas{display:block;width:100%;height:200px}
    .chart-legend{margin-top:8px;color:var(--muted);font-size:13px}

    .footer-note{margin-top:8px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Server-Informationen</h1>
      <nav class="nav">
        <a class="btn" href="./index.html">Statusseite</a>
        <a class="btn" href="./ping.html">Ping &amp; Latenz</a>
        <a class="btn" href="./rules.html">Regeln</a>
      </nav>
    </div>

    <!-- LIVE -->
    <section class="card" id="live">
      <h2>Live-Status
        <span class="src" id="srcLive">Quelle: /data/players.json</span>
      </h2>

      <div class="row">
        <div class="kpi">
          <strong>Status</strong>
          <div class="val"><span class="dot" id="dot"></span> <span id="statusTxt">—</span></div>
        </div>
        <div class="kpi">
          <strong>Online</strong>
          <div class="val" id="onlineVal">—</div>
        </div>
        <div class="kpi">
          <strong>Max</strong>
          <div class="val" id="maxVal">—</div>
        </div>
        <div class="kpi">
          <strong>MOTD</strong>
          <div class="val" id="motdVal">—</div>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px;">
        <strong>Zuletzt</strong>
        <div class="val" id="tsVal">—</div>
      </div>

      <div style="margin-top:12px">
        <strong>Spieler (letzter Stand)</strong>
        <div class="list" id="playersList">Keine Namen vom Server geliefert.</div>
        <div class="error" id="liveErr" style="display:none;margin-top:8px;"></div>
      </div>
    </section>

    <!-- Verlauf 24h -->
    <section class="card">
      <h2>Spieler-Verlauf (24 h)
        <span class="src" id="srcHist">Quelle: /data/players.json</span>
      </h2>
      <div class="chartbox"><canvas id="hist24"></canvas></div>
      <div class="chart-legend">
        Ø 24 h: <strong id="avg24">—</strong> &nbsp; • &nbsp; Peak 24 h: <strong id="peak24">—</strong>
      </div>
      <div class="footer-note">Falls kein Verlauf in <code>players.json</code> vorhanden ist, bleibt dieser Chart leer.</div>
    </section>

    <!-- Server-Block -->
    <section class="card">
      <h2>Server
        <span class="src" id="srcSrv">Quelle: /data/status.json</span>
      </h2>
      <div class="kpis">
        <div class="kpi">
          <strong>Name</strong>
          <div class="val" id="srvName">—</div>
        </div>
        <div class="kpi">
          <strong>Host:Port</strong>
          <div class="val" id="srvHost">—</div>
        </div>
        <div class="kpi">
          <strong>Zuletzt Status</strong>
          <div class="val" id="srvLast">—</div>
        </div>
        <div class="kpi">
          <strong>Letzter Zustand</strong>
          <div class="val" id="srvOk">—</div>
        </div>
      </div>
      <div class="error" id="srvErr" style="display:none;margin-top:8px;"></div>
      <div class="footer-note">Aktualisierung alle 5 Min.</div>
    </section>

  </div>

  <script>
  (function(){
    // ----- Quellen (lokal → Fallback Raw-GitHub) -----
    const RAW_BASE = "https://raw.githubusercontent.com/F1NN303/mc-server-status/main";
    const SRC_PLAYERS_LOCAL = "/data/players.json";
    const SRC_PLAYERS_RAW   = RAW_BASE + "/data/players.json";
    const SRC_STATUS_LOCAL  = "/data/status.json";
    const SRC_STATUS_RAW    = RAW_BASE + "/data/status.json";

    // kleine Helfer
    const $ = sel => document.querySelector(sel);
    const fmtNum = n => (n==null||Number.isNaN(n) ? "—" : new Intl.NumberFormat("de-DE").format(n));
    const fmtTs = s => {
      if(!s) return "—";
      // akzepiere ISO (mit/ohne Z) oder UNIX(ms)
      try{
        let d = (typeof s==="number") ? new Date(s) : new Date(String(s));
        if(isNaN(d)) return "—";
        return d.toLocaleString("de-DE",{hour12:false});
      }catch{ return "—"; }
    };

    async function fetchWithFallback(localUrl, rawUrl){
      // cache-buster, um Vercel/Browser-Caches zu umgehen
      const t = Date.now();
      try{
        const r = await fetch(localUrl + "?t=" + t, {cache:"no-store"});
        if(r.ok) return { data: await r.json(), src: localUrl };
        // 404 → Fallback
      }catch(e){}
      // Fallback versuchen
      const r2 = await fetch(rawUrl + "?" + t, {cache:"no-store"});
      if(!r2.ok) throw new Error("HTTP "+r2.status+" bei "+rawUrl);
      return { data: await r2.json(), src: rawUrl.replace(RAW_BASE,"(raw)") };
    }

    function renderLive(players, srcUsed){
      $("#srcLive").textContent = "Quelle: " + srcUsed.replace(location.origin,"");
      const last = players?.last || players; // erlaubt sowohl {last:{...}} als auch flach
      const ok = !!last?.online || last?.ok === true;

      $("#statusTxt").textContent = ok ? "online" : "offline";
      $("#dot").className = "dot " + (ok ? "ok" : "bad");
      $("#onlineVal").textContent = fmtNum(last?.online ?? last?.players ?? 0);
      $("#maxVal").textContent = fmtNum(last?.max ?? last?.maxPlayers ?? 0);
      $("#motdVal").textContent = (last?.motd ?? last?.motd_raw ?? last?.motd_clean ?? "—").toString().slice(0,120);
      $("#tsVal").textContent = fmtTs(last?.ts ?? last?.time ?? players?.generated);

      const names = last?.names || last?.playerSample || [];
      $("#playersList").textContent = (Array.isArray(names) && names.length)
        ? names.join(", ")
        : "Keine Namen vom Server geliefert.";
    }

    function renderHist24(players, srcUsed){
      $("#srcHist").textContent = "Quelle: " + srcUsed.replace(location.origin,"");
      const hist = players?.history || players?.samples || [];
      if(!Array.isArray(hist) || hist.length === 0){
        // kein Verlauf → Canvas leer lassen
        $("#avg24").textContent = "—";
        $("#peak24").textContent = "—";
        return;
      }
      const now = Date.now();
      const cutoff = now - 24*60*60*1000;
      const pts = hist
        .map(p => ({ t: (typeof p.ts==="number"?p.ts:Date.parse(p.ts)), v: Number(p.online ?? p.players ?? 0) }))
        .filter(p => !isNaN(p.t) && p.t >= cutoff)
        .sort((a,b)=>a.t-b.t);

      if(pts.length === 0){
        $("#avg24").textContent = "—"; $("#peak24").textContent = "—"; return;
      }
      // Metriken
      const sum = pts.reduce((s,p)=>s+p.v,0);
      const avg = sum / pts.length;
      const peak = Math.max(...pts.map(p=>p.v));
      $("#avg24").textContent = fmtNum(avg.toFixed(2));
      $("#peak24").textContent = fmtNum(peak);

      // zeichnen (simple canvas line)
      const cv = $("#hist24");
      const ctx = cv.getContext("2d");
      // Canvas richtig skalieren (für DPR)
      const DPR = Math.max(1, devicePixelRatio || 1);
      const W = cv.clientWidth, H = cv.clientHeight;
      cv.width = Math.floor(W*DPR); cv.height = Math.floor(H*DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);

      ctx.clearRect(0,0,W,H);
      // Gitter
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.lineWidth = 1;
      for(let i=0;i<10;i++){
        const y = (H-20) * (i/10) + 10;
        ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(W-10,y); ctx.stroke();
      }
      // Achsen
      ctx.strokeStyle = "rgba(255,255,255,0.15)";
      ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,H-10); ctx.lineTo(W-10,H-10); ctx.stroke();

      // Skalen
      const minT = pts[0].t, maxT = pts[pts.length-1].t;
      const minV = 0, maxV = Math.max(1, peak);
      function xOf(t){ return 40 + (W-50) * ((t - minT) / (maxT - minT || 1)); }
      function yOf(v){ return (H-10) - (H-20) * ((v - minV) / (maxV - minV || 1)); }

      // Linie
      ctx.strokeStyle = "#4fb7ff";
      ctx.lineWidth = 2;
      ctx.beginPath();
      pts.forEach((p,i)=>{
        const x = xOf(p.t), y = yOf(p.v);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function renderServer(status, srcUsed){
      $("#srcSrv").textContent = "Quelle: " + srcUsed.replace(location.origin,"");
      const svc = status?.service || {};
      $("#srvName").textContent = svc?.name || "—";
      $("#srvHost").textContent = (svc?.host && svc?.port!=null) ? `${svc.host}:${svc.port}` : "—";
      $("#srvLast").textContent = fmtTs(status?.generated);
      const lastOk = Array.isArray(status?.history) ? status.history.at(-1)?.ok : undefined;
      $("#srvOk").textContent = (lastOk===true) ? "online" : (lastOk===false ? "offline" : "—");
    }

    async function loadAll(){
      // LIVE / PLAYERS
      try{
        const {data,src} = await fetchWithFallback(SRC_PLAYERS_LOCAL, SRC_PLAYERS_RAW);
        renderLive(data, src);
        renderHist24(data, src);
        $("#liveErr").style.display = "none";
      }catch(e){
        $("#liveErr").style.display = "";
        $("#liveErr").textContent = "Fehler beim Laden: " + (e.message || e);
      }

      // SERVER / STATUS
      try{
        const {data,src} = await fetchWithFallback(SRC_STATUS_LOCAL, SRC_STATUS_RAW);
        renderServer(data, src);
        $("#srvErr").style.display = "none";
      }catch(e){
        $("#srvErr").style.display = "";
        $("#srvErr").textContent = "Status konnte nicht geladen werden: " + (e.message || e);
      }
    }

    loadAll();
    // Auto-Refresh alle 5 Min
    setInterval(loadAll, 5*60*1000);
  })();
  </script>
</body>
</html>