<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="robots" content="noindex, nofollow"/>
<title>Server-Infos â€“ Minecraft Bedrock</title>
<meta name="color-scheme" content="dark light"/>
<link rel="icon" href="/favicon.ico">
<style>
:root{
  --bg:#0b0d11; --panel:#0f1320; --line:#1b2231;
  --fg:#e6e7eb; --muted:#9aa0a6;
  --g:#19c37d; --r:#ef4444; --o:#f59e0b; --u:#95a3b6;
  --accent:#93c5fd; --radius:12px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:28px auto;padding:0 16px}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:16px}
h1{margin:0;font-size:22px}
.btn,.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);
  background:linear-gradient(180deg,var(--panel),#0b0f1a);color:var(--fg);font-size:13px}
.btn{cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.card{background:linear-gradient(180deg,var(--panel),#0c111c);border:1px solid var(--line);border-radius:var(--radius)}
.pad{padding:16px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px}
.kv div{min-height:22px;display:flex;align-items:center}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{border:1px solid var(--line);background:linear-gradient(180deg,#0c1423,#0a0f1a);padding:6px 10px;border-radius:999px;font-size:12px}
.good{color:#b0f1cf} .warn{color:#fde68a} .bad{color:#fecaca}
.hr{height:1px;background:var(--line);margin:10px 0}
.players-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.spark{height:42px;width:100%;border:1px dashed #2a3242;border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px}
.spark-canvas{display:none} /* wird nur gezeigt, wenn players.json vorhanden */
.footer-note{margin-top:10px;font-size:12px;color:#fbbf24}
.links{display:flex;gap:8px;flex-wrap:wrap}
.tip{font-size:12px;color:var(--muted);margin-top:6px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.dot.g{background:var(--g)} .dot.r{background:var(--r)} .dot.u{background:var(--u)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Server-Infos</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button id="copyBtn" class="btn" title="IP kopieren">ðŸ“‹ IP kopieren</button>
      <button id="themeBtn" class="btn" title="Theme umschalten">ðŸŒ“ Theme</button>
    </div>
  </header>

  <div class="grid">
    <!-- Steckbrief -->
    <section class="card">
      <div class="pad">
        <h2 style="margin:0 0 10px">Steckbrief</h2>
        <div class="kv">
          <div><strong>Name</strong></div><div id="s-name">Minecraft Bedrock</div>
          <div><strong>IP:Port</strong></div><div id="s-host">important-instrumentation.gl.at.ply.gg:18232</div>
          <div><strong>Edition</strong></div><div id="s-ed">Bedrock</div>
          <div><strong>Status</strong></div><div id="s-status"><span class="small">lÃ¤dt â€¦</span></div>
        </div>
        <div class="badges">
          <span class="badge">Uptime 24 h: <strong id="upt-24">â€”</strong></span>
          <span class="badge">Uptime 7 d: <strong id="upt-7d">â€”</strong></span>
          <span class="badge">Downtime 24 h: <strong id="down-24">â€”</strong></span>
        </div>
        <div class="hr"></div>
        <div class="links">
          <a class="chip" href="./index.html">ðŸ“Š Status</a>
          <a class="chip" href="./ping.html">ðŸ”§ Ping &amp; Latenz</a>
          <a class="chip" href="./rules.html">ðŸ“œ Regeln</a>
          <a class="chip" href="https://discord.gg/GtCaTP7GW6" target="_blank" rel="noopener">ðŸ’¬ Discord</a>
        </div>
        <div class="tip">Diese Seite aktualisiert Live-Daten alle 60 s. Zahlen kÃ¶nnen leicht abweichen.</div>
      </div>
    </section>

    <!-- Spieler -->
    <section class="card">
      <div class="pad">
        <h2 style="margin:0 0 10px">Spieler</h2>
        <div class="players-row">
          <span class="chip">Jetzt online: <strong id="p-now">â€”</strong></span>
          <span class="chip">Max Capacity: <strong id="p-max">â€”</strong></span>
          <span class="chip">Peak 24 h: <strong id="p-peak">n/v</strong></span>
          <span class="chip">Ã˜ 24 h: <strong id="p-avg">n/v</strong></span>
        </div>
        <div id="spark-wrap" class="spark" aria-live="polite">24 h-Spieler-Chart nicht verfÃ¼gbar</div>
        <canvas id="spark" class="spark-canvas" height="70"></canvas>
        <div class="tip">â€žPeak/Ã˜ 24 hâ€œ und Mini-Chart erscheinen automatisch, sobald <code>data/players.json</code> existiert.</div>
      </div>
    </section>
  </div>

  <!-- Geplante Wartung unten -->
  <section class="card" id="maint" style="margin-top:12px;display:none">
    <div class="pad">
      <h2 style="margin:0 0 10px">Geplante Wartung</h2>
      <div id="maint-body" class="small">â€”</div>
    </div>
  </section>

  <p class="footer-note">Diese Daten sind SchÃ¤tzungen bzw. Pings an den Server und kÃ¶nnen nicht zu 100 % stimmen.</p>
</div>

<script>
/* Endpoints (wie index) */
const API_LIVE='/api/bedrock';
const API_HIST='/api/history';
const API_INC='/incidents.json';
const API_PLAYERS='/data/players.json'; // optional

/* DOM */
const $=id=>document.getElementById(id);
const sName=$('s-name'), sHost=$('s-host'), sEd=$('s-ed'), sStatus=$('s-status');
const upt24=$('upt-24'), upt7=$('upt-7d'), down24=$('down-24');
const pNow=$('p-now'), pMax=$('p-max'), pPeak=$('p-peak'), pAvg=$('p-avg');
const spark=$('spark'), sparkWrap=$('spark-wrap');
const maint=$('maint'), maintBody=$('maint-body');

/* Theme + Copy (wie index) */
(function(){
  const btn=document.getElementById('themeBtn');
  const apply=t=>{ document.documentElement.style.colorScheme=(t==='light'?'light':'dark'); };
  let cur=localStorage.getItem('theme')||'auto';
  if(cur==='auto') apply(matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'); else apply(cur);
  btn.addEventListener('click', ()=>{
    cur=(cur==='dark'?'light':(cur==='light'?'auto':'dark'));
    localStorage.setItem('theme',cur);
    apply(cur==='auto'?(matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'):cur);
    btn.textContent='ðŸŒ“ '+(cur==='auto'?'Auto':(cur==='light'?'Light':'Dark'));
  });
  btn.textContent='ðŸŒ“ '+(cur==='auto'?'Auto':(cur==='light'?'Light':'Dark'));
})();
document.getElementById('copyBtn').addEventListener('click', async ()=>{
  const text=sHost.textContent.trim();
  try{ await navigator.clipboard.writeText(text);
       const b=document.getElementById('copyBtn'); b.textContent='âœ… Kopiert!'; setTimeout(()=>b.textContent='ðŸ“‹ IP kopieren',1400); }
  catch{ prompt('Kopiere IP:', text); }
});

/* Helpers (wie index) */
const fmtPct=v=> isFinite(v)?(v*100).toFixed(2)+'%':'â€”';
const fmtMin=m=> m<60?`${m} min`:`${Math.floor(m/60)} h ${m%60} min`;
async function getJSON(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(String(r.status)); return r.json(); }
function toIntervals(points, nowISO){
  const arr=[...points].sort((a,b)=>new Date(a.ts)-new Date(b.ts));
  const out=[];
  for(let i=0;i<arr.length;i++){
    const from=new Date(arr[i].ts);
    const to=new Date(i<arr.length-1?arr[i+1].ts:(nowISO||new Date().toISOString()));
    let mins=Math.max(1, Math.round((to-from)/60000));
    if(mins>30) mins=30;
    out.push({from:arr[i].ts,to:to.toISOString(),ok:arr[i].ok,mins});
  }
  return out;
}
const DAY_MS=86400000;
function sliceSince(intervals, sinceMs){
  return intervals.filter(i=> new Date(i.from).getTime()>=sinceMs || new Date(i.to).getTime()>sinceMs);
}
function sumDur(intervals, pred){ return intervals.reduce((a,i)=> a+(pred(i)?i.mins:0), 0); }

/* Live + Steckbrief + Spieler jetzt */
async function loadLive(){
  try{
    const live=await getJSON(API_LIVE+'?t='+Date.now());
    const name = live?.service?.name || 'Minecraft Bedrock';
    const host = (live?.service?.host && live?.service?.port!=null)
      ? `${live.service.host}:${live.service.port}`
      : 'important-instrumentation.gl.at.ply.gg:18232';
    const ok = live?.ok;

    sName.textContent=name;
    sHost.textContent=host;
    sStatus.innerHTML = ok===true ? '<span class="dot g"></span>online'
                      : ok===false ? '<span class="dot r"></span>offline'
                                   : '<span class="dot u"></span>unbekannt';

    const cur = live?.players?.online ?? live?.playersOnline ?? live?.online ?? null;
    const max = live?.players?.max    ?? live?.playersMax    ?? live?.max    ?? null;
    pNow.textContent = (cur!=null?cur:'â€”');
    pMax.textContent = (max!=null?max:'â€”');
  }catch{
    sStatus.innerHTML='<span class="dot u"></span>unbekannt';
    pNow.textContent='â€”'; pMax.textContent='â€”';
  }
}

/* Uptime 24h/7d */
async function loadUptime(){
  try{
    const [h24, h7] = await Promise.all([
      getJSON(API_HIST+'?range=24h'),
      getJSON(API_HIST+'?range=7d')
    ]);
    const now = (h24.generated || new Date().toISOString());
    const i24 = toIntervals(Array.isArray(h24.history)?h24.history:[], now);
    const i7  = toIntervals(Array.isArray(h7.history)?h7.history:[], now);

    const since24 = Date.now()-24*60*60*1000;
    const last24  = sliceSince(i24, since24);

    const on24  = sumDur(last24, i=>i.ok===true);
    const off24 = sumDur(last24, i=>i.ok===false);
    const total24 = on24+off24 || 1;

    upt24.textContent = fmtPct(on24/total24);
    down24.textContent = fmtMin(off24);

    const on7  = sumDur(i7, i=>i.ok===true);
    const off7 = sumDur(i7, i=>i.ok===false);
    const tot7 = on7+off7 || 1;
    upt7.textContent = fmtPct(on7/tot7);
  }catch{
    upt24.textContent='â€”'; upt7.textContent='â€”'; down24.textContent='â€”';
  }
}

/* Players 24h (optional) */
async function loadPlayersSpark(){
  try{
    const r = await fetch(API_PLAYERS, {cache:'no-store'});
    if(!r.ok) throw new Error('no players.json');
    const arr = await r.json();
    if(!Array.isArray(arr) || !arr.length) throw new Error('empty');

    const since = Date.now()-24*60*60*1000;
    const pts = arr.filter(p=> new Date(p.ts).getTime() >= since)
                   .map(p=> ({t:new Date(p.ts).getTime(), v: Number(p.online||0)}));
    if(!pts.length) throw new Error('no 24h points');

    const peak = Math.max(...pts.map(p=>p.v));
    const avg  = pts.reduce((a,b)=>a+b.v,0)/pts.length;
    pPeak.textContent = String(peak);
    pAvg.textContent  = String(Math.round(avg));

    const canvas = spark; const ctx=canvas.getContext('2d');
    canvas.width = canvas.clientWidth || 680;
    const W=canvas.width, H=canvas.height;
    ctx.clearRect(0,0,W,H);
    const t0 = since, t1 = Date.now();
    const v0 = 0, v1 = Math.max(peak, 1);
    const x = t=> ( (t - t0) / (t1 - t0) ) * (W-20) + 10;
    const y = v=> H - ( (v - v0) / (v1 - v0) ) * (H-16) - 8;
    ctx.fillStyle = '#0a0f1a'; ctx.fillRect(0,0,W,H);
    ctx.strokeStyle = '#1b2231'; ctx.lineWidth=1; ctx.beginPath();
    ctx.moveTo(10,H-8); ctx.lineTo(W-10,H-8); ctx.stroke();
    ctx.strokeStyle = '#93c5fd'; ctx.lineWidth=2; ctx.beginPath();
    pts.forEach((p,i)=>{ const X=x(p.t), Y=y(p.v); i?ctx.lineTo(X,Y):ctx.moveTo(X,Y); });
    ctx.stroke();

    sparkWrap.style.display='none';
    canvas.style.display='block';
  }catch{
    sparkWrap.style.display='flex';
    spark.style.display='none';
    pPeak.textContent='n/v'; pAvg.textContent='n/v';
  }
}

/* Maintenance unten (falls vorhanden) */
async function loadMaintenance(){
  try{
    const inc = await getJSON(API_INC);
    if(!Array.isArray(inc)) throw new Error('invalid');
    const up = inc.filter(x=>x.planned && new Date(x.from).getTime() > Date.now())
                  .sort((a,b)=> new Date(a.from)-new Date(b.from))[0];
    if(up){
      const when = new Date(up.from).toLocaleString();
      maintBody.textContent = `${when} â€“ ${up.reason || 'Geplante Wartung'}`;
      maint.style.display='block';
    } else {
      maint.style.display='none';
    }
  }catch{ maint.style.display='none'; }
}

/* Init */
async function init(){
  await Promise.all([loadLive(), loadUptime(), loadPlayersSpark(), loadMaintenance()]);
  setInterval(()=>{ loadLive(); loadPlayersSpark(); loadMaintenance(); }, 60_000);
}
init();
</script>
</body>
</html>
