<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Server-Infos</title>
  <meta name="color-scheme" content="dark light"/>
  <style>
    :root{
      --bg:#0b0d11; --panel:#101522; --muted:#9aa0a6; --fg:#e6e7eb;
      --line:#1b2231; --g:#19c37d; --y:#ffb528; --r:#ef4444; --u:#95a3b6;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1000px;margin:28px auto;padding:0 16px}
    a{color:#93c5fd;text-decoration:none} a:hover{text-decoration:underline}

    /* Header + Nav */
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:18px}
    h1{margin:0;font-size:26px}
    .btn{display:inline-flex;align-items:center;gap:.6rem;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,var(--panel),#0b0f1a);color:var(--fg);cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Cards */
    .card{background:linear-gradient(180deg,var(--panel),#0c111b);border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:18px}
    .card h2{margin:0 0 12px 0;font-size:20px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}
    .kpi{border:1px solid var(--line);border-radius:10px;padding:12px;background:#0e1422}
    .kpi strong{font-weight:700}
    .muted{color:var(--muted)}
    .ok{color:var(--g)} .warn{color:var(--y)} .err{color:var(--r)}

    /* Tag */
    .tag{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .6rem;border-radius:999px;border:1px solid var(--line);background:#0f1420;font-size:.85rem;color:var(--muted)}

    /* Sparkline */
    .spark{width:100%;height:120px;display:block}
    .legend{font-size:.9rem;color:var(--muted);margin-top:6px}

    /* Player list */
    .list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0f1523}

    footer{margin:18px 0 10px;color:var(--muted);font-size:.9rem}
    code{background:#0e1422;border:1px solid var(--line);border-radius:6px;padding:0 .35rem}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header / Nav -->
    <div class="header">
      <h1>Server-Informationen</h1>
      <div class="nav">
        <a class="btn" href="./index.html">Statusseite</a>
        <a class="btn" href="./ping.html">Ping & Latenz</a>
        <a class="btn" href="./rules.html">Regeln</a>
      </div>
    </div>

    <!-- Live -->
    <div class="card" id="liveCard">
      <h2>Live-Status <span class="tag">Quelle: <code>/data/players.json</code></span></h2>
      <div class="kpis">
        <div class="kpi"><div class="muted">Status</div><div id="live-status"><em class="muted">—</em></div></div>
        <div class="kpi"><div class="muted">Online</div><div id="live-online"><em class="muted">—</em></div></div>
        <div class="kpi"><div class="muted">Max</div><div id="live-max"><em class="muted">—</em></div></div>
        <div class="kpi"><div class="muted">MOTD</div><div id="live-motd"><em class="muted">—</em></div></div>
        <div class="kpi"><div class="muted">Zuletzt</div><div id="live-upd"><em class="muted">—</em></div></div>
      </div>
      <div class="muted" style="margin-top:10px">Spieler (letzter Stand):</div>
      <div id="live-names" class="list"><span class="muted">Keine Namen vom Server geliefert.</span></div>
      <div id="live-error" class="err" style="margin-top:10px;display:none"></div>
    </div>

    <!-- Verlauf 24h -->
    <div class="card">
      <h2>Spieler-Verlauf (24 h)</h2>
      <svg class="spark" viewBox="0 0 600 120" preserveAspectRatio="none" id="spark"></svg>
      <div class="legend">Ø 24 h: <strong id="avg24">—</strong> • Peak 24 h: <strong id="peak24">—</strong></div>
      <footer>Quelle: <code>/data/players.json</code> (nur wenn History im JSON vorhanden ist).</footer>
    </div>

    <!-- Server -->
    <div class="card">
      <h2>Server</h2>
      <div class="kpis">
        <div class="kpi"><div class="muted">Name</div><div id="svc-name"><em class="muted">—</em></div></div>
        <div class="kpi"><div class="muted">Host:Port</div><div id="svc-host"><em class="muted">—</em></div></div>
        <div class="kpi"><div class="muted">Zuletzt Status</div><div id="svc-gen"><em class="muted">—</em></div></div>
      </div>
      <footer>Quelle: <code>/data/status.json</code> • Aktualisierung alle 5 Min.</footer>
    </div>

  </div>

  <script>
    // ---- helpers -----------------------------------------------------------
    const $ = sel => document.querySelector(sel);
    const fmtTime = iso => {
      if (!iso) return '—';
      try {
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        const pad = n => String(n).padStart(2,'0');
        return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} `+
               `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      } catch { return iso; }
    };

    // robust parsing (unterstützt verschiedene JSON-Formen)
    function parsePlayers(json){
      const j = json || {};
      const online = (j.online ?? j.ok ?? j.status?.online ?? false) ? true : false;
      const playersOnline = j.players?.online ?? j.player_count ?? j.playersOnline ?? 0;
      const max = j.players?.max ?? j.max_players ?? j.max ?? null;
      const motd = j.motd?.raw ?? j.motd?.clean ?? j.motd?.text ?? j.motd ?? '';
      const last = j.last_updated ?? j.generated ?? j.timestamp ?? '';

      // Namen
      let names = [];
      if (Array.isArray(j.players?.list)) names = j.players.list.map(n => typeof n === 'string' ? n : (n?.name ?? ''));
      else if (Array.isArray(j.players?.sample)) names = j.players.sample.map(n => typeof n === 'string' ? n : (n?.name ?? ''));
      else if (Array.isArray(j.sample)) names = j.sample.map(n => typeof n === 'string' ? n : (n?.name ?? ''));

      // Verlauf
      let hist = j.history ?? j.playerHistory ?? null;
      if (Array.isArray(hist)){
        hist = hist
          .map(p => {
            const t = p.ts ?? p.time ?? p.t ?? p.timestamp;
            const v = (p.players?.online ?? p.online ?? p.count ?? p.v ?? p.value ?? 0);
            const dd = t ? new Date(t) : null;
            return (!t || !dd || isNaN(dd)) ? null : { t: dd, v: Number(v)||0 };
          })
          .filter(Boolean)
          .sort((a,b)=>a.t-b.t);
        // Auf letzte 24h begrenzen
        const now = Date.now();
        hist = hist.filter(p => (now - p.t.getTime()) <= 24*60*60*1000);
      } else {
        hist = [];
      }
      return { online, playersOnline, max, motd, last, names, hist };
    }

    function drawSpark(data){
      const svg = $('#spark');
      svg.innerHTML = '';
      if (!data.length){ return; }

      const W = 600, H = 120, padL=6, padR=6, padT=8, padB=20;
      const xs = data.map(d => d.t.getTime());
      const ys = data.map(d => d.v);
      const minX = Math.min(...xs), maxX = Math.max(...xs);
      const minY = 0, maxY = Math.max(1, ...ys);
      const x = t => padL + ( (t-minX) / (maxX-minX || 1) ) * (W-padL-padR);
      const y = v => H-padB - ( (v-minY) / (maxY-minY || 1) ) * (H-padT-padB);

      let d = '';
      data.forEach((p,i)=>{
        const xx = x(p.t.getTime()), yy = y(p.v);
        d += (i? ' L':'M') + xx + ' ' + yy;
      });
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d);
      path.setAttribute('fill','none');
      path.setAttribute('stroke','#3ba9ff');
      path.setAttribute('stroke-width','2');
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      svg.appendChild(path);
    }

    // ---- fetch + render ----------------------------------------------------
    async function loadPlayers(){
      const elErr = $('#live-error');
      elErr.style.display = 'none';
      try{
        const res = await fetch('/data/players.json', {cache:'no-store'});
        if(!res.ok) throw new Error(String(res.status));
        const raw = await res.json();
        const p = parsePlayers(raw);

        // KPIs
        $('#live-status').innerHTML = p.online ? '<span class="ok">online</span>' : '<span class="err">offline</span>';
        $('#live-online').textContent = p.playersOnline ?? '—';
        $('#live-max').textContent = (p.max ?? '—');
        $('#live-motd').textContent = p.motd || '—';
        $('#live-upd').textContent = fmtTime(p.last);

        // Namen
        const list = $('#live-names');
        list.innerHTML = '';
        if (p.names && p.names.length){
          p.names.slice(0,40).forEach(n=>{
            const span = document.createElement('span');
            span.className = 'pill';
            span.textContent = n || 'Spieler';
            list.appendChild(span);
          });
        } else {
          const span = document.createElement('span');
          span.className = 'muted';
          span.textContent = 'Keine Namen vom Server geliefert.';
          list.appendChild(span);
        }

        // Verlauf
        if (p.hist.length){
          drawSpark(p.hist);
          const sum = p.hist.reduce((a,b)=>a+b.v,0);
          const avg = sum / p.hist.length;
          const peak = Math.max(...p.hist.map(h=>h.v));
          $('#avg24').textContent = avg.toFixed(2);
          $('#peak24').textContent = peak.toString();
        } else {
          $('#avg24').textContent = '—';
          $('#peak24').textContent = '—';
        }
      }catch(e){
        elErr.textContent = 'Fehler beim Laden: ' + e.message;
        elErr.style.display = 'block';
      }
    }

    async function loadStatus(){
      try{
        const res = await fetch('/data/status.json', {cache:'no-store'});
        if(!res.ok) throw new Error(String(res.status));
        const j = await res.json();
        $('#svc-name').textContent = j?.service?.name || '—';
        const host = j?.service?.host || '';
        const port = j?.service?.port ?? '';
        $('#svc-host').textContent = host ? (port? `${host}:${port}`: host) : '—';
        $('#svc-gen').textContent = fmtTime(j?.generated);
      }catch(e){
        $('#svc-name').innerHTML = '<span class="err">Fehler</span>';
        $('#svc-host').textContent = '—';
        $('#svc-gen').textContent = '—';
      }
    }

    // initial + Intervall
    loadPlayers(); loadStatus();
    setInterval(loadPlayers, 60*1000);
    setInterval(loadStatus, 60*1000);
  </script>
</body>
</html>