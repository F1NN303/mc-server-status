<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Server Info & Spieler</title>
  <meta name="color-scheme" content="dark light"/>
  <style>
    :root{
      --bg:#0b0d11;--panel:#0f1320;--line:#1b2231;
      --fg:#e6e7eb;--muted:#9aa0a6;--g:#19c37d;--r:#ef4444;--o:#f59e0b;--u:#95a3b6;
      --radius:12px
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:28px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,var(--panel),#0b0f1a)}
    .btn:hover{background:linear-gradient(180deg,#0e1524,#0b0f1a)}
    .card{background:linear-gradient(180deg,var(--panel),#0e111c);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
    .kpi{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
    .kpi strong{color:var(--fg);font-weight:600}
    .grid{display:grid;gap:12px}
    @media (min-width:900px){.grid{grid-template-columns:1.4fr .9fr}}
    .pill{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:6px 10px;background:#0b121d;border:1px solid var(--line)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--g)} .dot.r{background:var(--r)} .dot.o{background:var(--o)} .dot.u{background:var(--u)}
    .list{display:flex;flex-wrap:wrap;gap:6px}
    .chip{padding:4px 8px;border-radius:999px;background:#0d1420;border:1px solid var(--line);font-size:12px}
    canvas{width:100%;height:220px;display:block}
    .footer{margin-top:22px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Server-Infos & Spieler</h1>
      <div class="list">
        <a class="btn" href="./secret-status-bf6a3e31/index.html">Statusseite</a>
        <a class="btn" href="./secret-status-bf6a3e31/ping.html">Ping & Latenz</a>
        <a class="btn" href="./rules.html">Regeln</a>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <!-- Linke Spalte: Live -->
      <section class="card">
        <h2 style="margin:0 0 6px 0;font-size:20px">Live-Status</h2>
        <div id="svc" class="kpi">lädt…</div>

        <div class="kpi" id="livekpi" style="margin-top:12px">
          <span class="pill"><span class="dot g"></span><strong id="livecount">–</strong>&nbsp;online</span>
          <span class="pill">Max:&nbsp;<strong id="livemax">–</strong></span>
          <span class="pill">MOTD:&nbsp;<strong id="livemotd">–</strong></span>
          <span class="pill">Zuletzt:&nbsp;<strong id="livets">–</strong></span>
        </div>

        <div style="margin-top:12px">
          <div style="color:var(--muted);margin-bottom:6px;font-size:12px">Spieler (letzter Stand)</div>
          <div id="playerlist" class="list"></div>
        </div>
      </section>

      <!-- Rechte Spalte: 24h Chart -->
      <section class="card">
        <h2 style="margin:0 0 6px 0;font-size:20px">Spieler-Verlauf (24 h)</h2>
        <canvas id="chart24"></canvas>
        <div class="kpi">
          <span>Ø 24 h: <strong id="avg24">–</strong></span>
          <span>Peak 24 h: <strong id="peak24">–</strong></span>
        </div>
      </section>
    </div>

    <div class="footer">Quelle: <code>public/players.json</code>, <code>public/player-count-history.json</code> • Aktualisierung alle 5 Min.</div>
  </div>

<script>
(async function(){
  const $ = s=>document.querySelector(s);
  const fmt = d=>new Date(d).toLocaleString('de-DE',{hour12:false});

  // Pfade – werden von der Action erzeugt
  const LIVE_URL = '../players.json'; // relativ zu /public/info.html
  const HIST_URL = '../player-count-history.json';

  // Live laden
  let live;
  try {
    const r = await fetch(LIVE_URL,{cache:'no-store'});
    live = await r.json();
  } catch(e) { live = null; }

  if(!live || !live.generated){
    $('#svc').textContent = 'Keine Daten (players.json fehlt oder leer).';
  }else{
    $('#svc').innerHTML = `
      <div><strong>${live.service?.name || 'Minecraft Bedrock'}</strong></div>
      <div class="kpi">
        Host:&nbsp;<strong>${live.service?.host || '-'}</strong>&nbsp;•&nbsp;
        Port:&nbsp;<strong>${live.service?.port ?? '-'}</strong>
      </div>`;
    $('#livecount').textContent = live.playerCount ?? 0;
    $('#livemax').textContent = live.max ?? 0;
    $('#livemotd').textContent = (live.motd || '').toString().slice(0,80) || '–';
    $('#livets').textContent = fmt(live.generated);

    const box = $('#playerlist');
    box.innerHTML = '';
    const names = Array.isArray(live.players) ? live.players : [];
    if(names.length === 0){
      const span = document.createElement('span'); span.className='chip'; span.textContent='(keine Namen gemeldet)';
      box.appendChild(span);
    }else{
      names.slice(0,60).forEach(n=>{
        const s=document.createElement('span'); s.className='chip'; s.textContent=n||'(unbekannt)'; box.appendChild(s);
      });
      if(names.length>60){
        const s=document.createElement('span'); s.className='chip'; s.textContent=`+${names.length-60} weitere`; box.appendChild(s);
      }
    }
  }

  // History laden
  let hist=[];
  try{
    const r = await fetch(HIST_URL,{cache:'no-store'});
    hist = await r.json();
    if(!Array.isArray(hist)) hist=[];
  }catch(e){ hist=[]; }

  // 24h Fenster filtern
  const now = Date.now();
  const dayAgo = now - 24*60*60*1000;
  const h24 = hist.filter(s => new Date(s.ts).getTime() >= dayAgo);

  // Kennzahlen
  const avg = (arr)=> arr.length ? (arr.reduce((a,b)=>a+b.count,0)/arr.length) : 0;
  const pk  = (arr)=> arr.length ? Math.max(...arr.map(s=>s.count)) : 0;
  $('#avg24').textContent  = avg(h24).toFixed(2).replace('.',',');
  $('#peak24').textContent = pk(h24);

  // Mini-Canvas-Chart ohne Lib
  const cvs = document.getElementById('chart24');
  const ctx = cvs.getContext('2d');
  function drawChart(data){
    const W = cvs.clientWidth, H = cvs.clientHeight;
    cvs.width = Math.floor(W*devicePixelRatio); cvs.height = Math.floor(H*devicePixelRatio);
    ctx.scale(devicePixelRatio, devicePixelRatio);
    ctx.clearRect(0,0,W,H);

    // Achsen
    ctx.strokeStyle = '#1b2231'; ctx.lineWidth = 1;
    for(let i=0;i<=4;i++){
      const y = 10 + (H-20)*i/4;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }

    if(data.length<2) return;

    const t0 = new Date(data[0].ts).getTime();
    const t1 = new Date(data[data.length-1].ts).getTime();
    const dt = Math.max(1, t1 - t0);
    const cmax = Math.max(1, Math.max(...data.map(d=>d.count)));

    // Linie
    ctx.beginPath();
    ctx.lineWidth = 2; ctx.strokeStyle = '#93c5fd';
    data.forEach((d,i)=>{
      const x = ( (new Date(d.ts).getTime() - t0) / dt ) * (W-20) + 10;
      const y = (1 - (d.count/cmax)) * (H-20) + 10;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
  drawChart(h24);
  addEventListener('resize',()=>drawChart(h24),{passive:true});
})();
</script>
</body>
</html>