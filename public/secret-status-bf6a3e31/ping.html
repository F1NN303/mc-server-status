<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="robots" content="noindex, nofollow"/>
<title>Ping & Latenz</title>
<meta name="color-scheme" content="dark light"/>
<style>
:root{
  --bg:#0b0d11; --panel:#0f1320; --line:#1b2231;
  --fg:#e6e7eb; --muted:#9aa0a6;
  --g:#19c37d; --r:#ef4444; --o:#f59e0b; --u:#95a3b6;
  --radius:12px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1000px;margin:28px auto;padding:0 16px}
a{color:#93c5fd;text-decoration:none}
a:hover{text-decoration:underline}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
h1{margin:0;font-size:22px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);
     background:linear-gradient(180deg,var(--panel),#0b0f1a); color:var(--fg); cursor:pointer; text-decoration:none}
.btn:disabled{opacity:.6;cursor:not-allowed}
.card{background:linear-gradient(180deg,var(--panel),#0c111c);border:1px solid var(--line);
      border-radius:12px;padding:16px;margin-bottom:16px}
.hint{font-size:12px;color:var(--muted)}
.row{display:flex;gap:16px;flex-wrap:wrap}
.col{flex:1 1 420px;min-width:320px}
.kpis{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
       border:1px solid var(--line);font-size:12px;background:linear-gradient(180deg,#0c1423,#0a0f1a)}
.grid{display:flex;gap:2px;align-items:flex-end;height:80px;margin-top:8px}
.bar{width:4px;background:#374151;border-radius:2px}
.bar.ok{background:var(--g)} .bar.warn{background:var(--o)} .bar.bad{background:var(--r)}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>Ping &amp; Latenz</h1>
    <div>
      <a class="btn" href="/">← Zurück zum Status</a>
    </div>
  </div>

  <div class="row">
    <!-- Browser-HTTP-Ping -->
    <div class="col">
      <section class="card">
        <h2 style="margin:0 0 8px">Live HTTP-Ping (Browser)</h2>
        <div class="hint">Misst Roundtrip-Zeit zu <code>/api/bedrock</code> (HTTP, kein UDP/Bedrock). Gut für „gefühlte“ Latenz.</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="start">▶ Start</button>
          <button class="btn" id="stop" disabled>⏹ Stop</button>
          <label class="badge"><span>Interval</span>
            <select id="interval" style="background:transparent;border:none;color:var(--fg);outline:none">
              <option value="1000">1 s</option>
              <option value="2000" selected>2 s</option>
              <option value="5000">5 s</option>
            </select>
          </label>
          <label class="badge"><span>Samples</span>
            <select id="samples" style="background:transparent;border:none;color:var(--fg);outline:none">
              <option value="1">1</option>
              <option value="3" selected>3</option>
              <option value="5">5</option>
            </select>
          </label>
        </div>

        <div class="kpis">
          <div class="badge">Letzter: <strong id="last">–</strong></div>
          <div class="badge">Min/Avg/Max: <strong id="mam">–</strong></div>
          <div class="badge">p50/p95: <strong id="pp">–</strong></div>
          <div class="badge">Anzahl: <strong id="count">0</strong></div>
        </div>

        <div id="spark-http" class="grid" aria-label="HTTP Ping Sparkline"></div>
        <table class="table">
          <thead><tr><th>Zeit</th><th>ms</th><th class="small">Details</th></tr></thead>
          <tbody id="tbody-http"></tbody>
        </table>
      </section>
    </div>

    <!-- Server-/Action-Latenz -->
    <div class="col">
      <section class="card">
        <h2 style="margin:0 0 8px">UDP-Latenz (von Bot/Action)</h2>
        <div class="hint">Zeitreihe aus <code>/latency.json</code> (falls vorhanden). p50/p95 durch externen Job.</div>
        <div class="kpis">
          <div class="badge">Letzte p50/p95: <strong id="srv-last">–</strong></div>
          <div class="badge">Punkte: <strong id="srv-count">0</strong></div>
        </div>
        <div id="spark-srv" class="grid" aria-label="UDP Latency Sparkline"></div>
        <table class="table">
          <thead><tr><th>Zeit</th><th>p50</th><th>p95</th><th class="small">Samples</th></tr></thead>
          <tbody id="tbody-srv"></tbody>
        </table>
        <div class="hint">Hinweis: Wenn hier nichts erscheint, existiert <code>public/latency.json</code> (noch) nicht.</div>
      </section>
    </div>
  </div>

  <p class="small">Tipp: HTTP-Ping ≠ UDP-Bedrock-Ping. Für echte Bedrock-Latenz brauchst du eine Messung außerhalb des Browsers (z.&nbsp;B. dein GitHub-Action-Job).</p>
</div>

<script>
const API_HTTP = '/api/bedrock';   // HTTP-Endpoint für Browser-Ping
const API_SRV  = '/latency.json';  // UDP-Zeitreihe vom externen Job (falls vorhanden)

const $ = s => document.querySelector(s);
const tbodyHttp = $('#tbody-http');
const sparkHttp = $('#spark-http');
const lastEl = $('#last'), mamEl = $('#mam'), ppEl = $('#pp'), countEl = $('#count');

const tbodySrv = $('#tbody-srv');
const sparkSrv = $('#spark-srv');
const srvLastEl = $('#srv-last'), srvCountEl = $('#srv-count');

let timer = null;
let seriesHttp = []; // {ts, ms, tries, values[]}

/* ========== Browser HTTP Ping ========== */
async function pingHTTP(n=3){
  const values=[];
  for(let i=0;i<n;i++){
    const t0=performance.now();
    try{
      // small GET mit cache-busting
      await fetch(API_HTTP + '?ping=' + Date.now(), {cache:'no-store', method:'GET'});
      const ms = Math.round(performance.now() - t0);
      values.push(ms);
    }catch{
      values.push(null);
    }
  }
  const filtered = values.filter(v=>v!==null);
  return {
    ts: new Date().toISOString(),
    tries: n,
    values,
    ms: filtered.length? Math.round(filtered.reduce((a,b)=>a+b,0)/filtered.length) : null
  };
}

function renderHttp(){
  // KPIs
  const arr = seriesHttp;
  $('#count').textContent = String(arr.length);
  const last = arr[arr.length-1];
  lastEl.textContent = last?.ms!=null ? `${last.ms} ms` : '–';

  const all = arr.map(x=>x.ms).filter(v=>v!=null);
  if(all.length){
    const min = Math.min(...all), max = Math.max(...all), avg = Math.round(all.reduce((a,b)=>a+b,0)/all.length);
    const p = [...all].sort((a,b)=>a-b);
    const p50 = p[Math.floor(0.5*(p.length-1))];
    const p95 = p[Math.floor(0.95*(p.length-1))];
    mamEl.textContent = `${min}/${avg}/${max} ms`;
    ppEl.textContent = `${p50}/${p95} ms`;
  }else{
    mamEl.textContent = '–';
    ppEl.textContent = '–';
  }

  // Tabelle (max 30 Zeilen)
  while(tbodyHttp.firstChild) tbodyHttp.removeChild(tbodyHttp.firstChild);
  arr.slice(-30).reverse().forEach(x=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=new Date(x.ts).toLocaleTimeString();
    const td2=document.createElement('td'); td2.textContent=(x.ms!=null?x.ms:'–');
    const td3=document.createElement('td'); td3.className='small'; td3.textContent=`${x.tries}x: ${x.values.map(v=>v??'×').join(', ')}`;
    tr.append(td1,td2,td3); tbodyHttp.appendChild(tr);
  });

  // Sparkline (letzte 80 Punkte)
  sparkHttp.innerHTML='';
  const last80 = arr.slice(-80);
  const max = Math.max(100, ...last80.map(x=>x.ms||0));
  last80.forEach(x=>{
    const h = Math.round(Math.min(1,(x.ms||0)/max) * 76) + 4;
    const d = document.createElement('div');
    let cls='bar'; 
    if(x.ms==null) cls+=' bad';
    else if(x.ms>=400) cls+=' bad';
    else if(x.ms>=200) cls+=' warn';
    else cls+=' ok';
    d.className=cls; d.style.height=h+'px';
    sparkHttp.appendChild(d);
  });
}

$('#start').addEventListener('click', async ()=>{
  $('#start').disabled=true; $('#stop').disabled=false;
  const every = parseInt($('#interval').value,10);
  const n = parseInt($('#samples').value,10);
  // sofort einer:
  seriesHttp.push(await pingHTTP(n));
  renderHttp();
  // dann Intervall:
  timer = setInterval(async ()=>{
    seriesHttp.push(await pingHTTP(n));
    renderHttp();
  }, every);
});
$('#stop').addEventListener('click', ()=>{
  if(timer){ clearInterval(timer); timer=null; }
  $('#start').disabled=false; $('#stop').disabled=true;
});

/* ========== Serverseitige UDP-Latenz (Zeitreihe) ========== */
async function loadSrvLatency(){
  try{
    const r = await fetch(API_SRV, {cache:'no-store'});
    if(!r.ok) throw 0;
    return await r.json();
  }catch{
    return [];
  }
}
function renderSrv(series){
  srvCountEl.textContent = String(series.length);
  while(tbodySrv.firstChild) tbodySrv.removeChild(tbodySrv.firstChild);
  if(!series.length){
    srvLastEl.textContent = '–';
    sparkSrv.innerHTML='';
    return;
  }
  const last = series[series.length-1];
  srvLastEl.textContent = (last.p50_ms!=null && last.p95_ms!=null) ? `${last.p50_ms}/${last.p95_ms} ms` : '–';

  series.slice(-50).reverse().forEach(x=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=new Date(x.ts).toLocaleString();
    const td2=document.createElement('td'); td2.textContent=(x.p50_ms??'–');
    const td3=document.createElement('td'); td3.textContent=(x.p95_ms??'–');
    const td4=document.createElement('td'); td4.className='small'; td4.textContent=Array.isArray(x.samples)? x.samples.join(', ') : '';
    tr.append(td1,td2,td3,td4); tbodySrv.appendChild(tr);
  });

  // Spark
  sparkSrv.innerHTML='';
  const last80 = series.slice(-80);
  const max = Math.max(100, ...last80.map(x=>x.p95_ms||0));
  last80.forEach(x=>{
    const h = Math.round(Math.min(1,(x.p95_ms||0)/max) * 76) + 4;
    const d = document.createElement('div');
    let cls='bar';
    const v = x.p95_ms||0;
    if(v>=400) cls+=' bad'; else if(v>=200) cls+=' warn'; else cls+=' ok';
    d.className=cls; d.style.height=h+'px';
    sparkSrv.appendChild(d);
  });
}

(async ()=>{
  // Lade vorhandene UDP-Zeitreihe einmalig beim Start
  const srv = await loadSrvLatency();
  renderSrv(Array.isArray(srv)?srv:[]);
})();
</script>
</body>
</html>
