<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Minecraft Bedrock – Status</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0d11; --panel:#0f1320; --line:#1b2231; --line2:#111623;
      --fg:#e6e7eb; --muted:#9aa0a6;
      --g:#19c37d; --r:#ef4444; --u:#95a3b6;
      --bar-w:12px; --bar-gap:6px; --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{margin:0;font-size:22px}
    .pill{display:inline-flex;align-items:center;gap:8px;
      background:linear-gradient(180deg,var(--panel),#0b0f1a);
      border:1px solid var(--line); padding:8px 12px;border-radius:999px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--g)} .dot.r{background:var(--r)} .dot.u{background:var(--u)}

    .top-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .seg input{display:none}
    .seg label{padding:6px 10px;font-size:12px;color:var(--muted);cursor:pointer}
    .seg input:checked + label{background:var(--line);color:var(--fg)}
    .toggle{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .toggle input{accent-color:#60a5fa}

    .card{background:linear-gradient(180deg,var(--panel),#0c111c);border:1px solid var(--line);
      border-radius:var(--radius);padding:16px}
    .row-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .svc{display:flex;flex-direction:column;gap:4px}
    .svc-name{font-weight:700}
    .svc-host{font-size:12px;color:var(--muted)}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);font-size:12px;background:linear-gradient(180deg,#0c1423,#0a0f1a)}
    .kpi{display:flex;gap:16px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
    .kpi strong{color:var(--fg);font-weight:600}

    .bars-wrap{margin-top:12px}
    .bars{position:relative;display:flex;gap:var(--bar-gap);align-items:flex-end;
      min-height:90px;overflow-x:auto;padding:10px;border-radius:12px;background:linear-gradient(180deg,#0a0e19,#0a0d14)}
    .bar{width:var(--bar-w);flex:0 0 var(--bar-w);border-radius:8px;background:#2a3242;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
    .bar.g{background:var(--g)} .bar.r{background:var(--r)} .bar.u{background:var(--u)}
    .bar:focus{outline:2px solid #60a5fa}
    .footline{display:flex;justify-content:space-between;color:var(--muted);
      font-size:12px;margin:6px 4px 0}

    .legend{display:flex;gap:14px;color:var(--muted);font-size:12px;flex-wrap:wrap;margin-top:8px}
    .lg{display:inline-flex;align-items:center;gap:6px}
    .sq{width:10px;height:10px;border-radius:2px}
    .sq.g{background:var(--g)} .sq.r{background:var(--r)} .sq.u{background:var(--u)}

    .tip{position:fixed;pointer-events:none;z-index:70;transform:translate(-50%,-120%);
      background:#0b0f18;border:1px solid var(--line);padding:8px 10px;border-radius:8px;
      font-size:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);display:none;min-width:220px}
    .t-line{display:flex;justify-content:space-between;gap:10px}

    .incidents{margin-top:10px}
    .incidents h3{margin:8px 0 6px;font-size:13px;color:var(--muted);font-weight:600}
    .incidents ul{margin:0;padding-left:16px;font-size:12px;color:var(--muted)}
    .incidents li{margin:4px 0}

    .stale{margin-top:8px;font-size:12px;color:#fbbf24}
    .disclaimer{margin-top:8px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header aria-label="Seitenkopf">
      <h1>Minecraft Bedrock – Status</h1>
      <div class="pill" id="live-pill" aria-live="polite" title="Aktueller Live-Status">
        <span class="dot u" id="live-dot" aria-hidden="true"></span>
        <span id="live-txt">Lade Live-Status …</span>
      </div>
    </header>

    <div class="top-row" role="toolbar" aria-label="Ansicht">
      <div class="seg" id="range">
        <input type="radio" name="r" id="r24" value="24h" checked><label for="r24">24 h</label>
        <input type="radio" name="r" id="r7" value="7d"><label for="r7">7 d</label>
        <input type="radio" name="r" id="r30" value="30d"><label for="r30">30 d</label>
      </div>
      <label class="toggle"><input type="checkbox" id="auto" checked /> Live-Refresh (60 s)</label>
      <label class="toggle"><input type="checkbox" id="unkAsOff" /> Unknown als offline werten (nur Anzeige)</label>
    </div>

    <section class="card" aria-label="Service Status">
      <div class="row-head">
        <div class="svc">
          <div class="svc-name" id="svc-name">Minecraft Bedrock</div>
          <div class="svc-host" id="svc-host">–</div>
        </div>
        <div class="badges">
          <div class="badge" title="Uptime der gewählten Zeitspanne">
            <span>Uptime</span><strong id="uptime">–</strong>
          </div>
          <div class="badge" title="Gesamt-Downtime in der Zeitspanne">
            <span>Downtime</span><strong id="downtime">–</strong>
          </div>
        </div>
      </div>

      <div class="kpi" id="kpi">
        <div><strong id="kpi-online">–</strong> online</div>
        <div><strong id="kpi-offline">–</strong> offline</div>
        <div><strong id="kpi-unknown">–</strong> unknown</div>
        <div><strong id="kpi-points">–</strong> Punkte</div>
      </div>

      <div class="bars-wrap">
        <div id="bars" class="bars" role="group" aria-label="Status-Zeitachse"></div>
        <div class="footline">
          <span id="foot-left">30 days</span>
          <span id="foot-right">Today</span>
        </div>
      </div>

      <div class="legend" aria-hidden="true">
        <span class="lg"><span class="sq g"></span> online</span>
        <span class="lg"><span class="sq r"></span> offline</span>
        <span class="lg"><span class="sq u"></span> unbekannt</span>
        <span class="lg">• 1 Balken = 5 Min (24 h) • 1 Balken = 1 Tag (7 d/30 d) • <span id="meta-src">Quelle: History</span></span>
      </div>

      <!-- NEU: Hinweis -->
      <p class="disclaimer">Diese Daten sind Schätzungen bzw. Pings an den Server und können nicht zu 100&nbsp;% stimmen.</p>

      <div class="incidents" id="inc"></div>
      <div class="stale" id="stale" hidden>Hinweis: History ist älter als 30 Min. Live-Pille zeigt aktuellen Zustand.</div>
    </section>
  </div>

  <div class="tip" id="tip">
    <div class="t-line"><span id="tip-status">–</span><span id="tip-ts">–</span></div>
    <div class="t-line"><span id="tip-src">–</span><span id="tip-range">–</span></div>
  </div>

  <script>
    const API_HISTORY='/api/history', API_LIVE='/api/bedrock';
    const SLOT_MIN=5, DAY_SLOTS=(24*60)/SLOT_MIN, STALE_MIN=30, INCIDENT_MIN=15;

    const liveDot=byId('live-dot'), liveTxt=byId('live-txt'), svcName=byId('svc-name'), svcHost=byId('svc-host');
    const barsEl=byId('bars'), footL=byId('foot-left'), footR=byId('foot-right'), metaSrc=byId('meta-src');
    const uptimeEl=byId('uptime'), dtimeEl=byId('downtime'), kOnline=byId('kpi-online'), kOffline=byId('kpi-offline'), kUnknown=byId('kpi-unknown'), kPoints=byId('kpi-points');
    const incWrap=byId('inc'), staleEl=byId('stale'), rangeCtl=byId('range'), autoCtl=byId('auto'), unkCtl=byId('unkAsOff');
    const TIP=byId('tip'), TIP_TS=byId('tip-ts'), TIP_ST=byId('tip-status'), TIP_SRC=byId('tip-src'), TIP_RANGE=byId('tip-range');
    function byId(id){return document.getElementById(id)}

    const STATUS=(ok,uAsOff=false)=> ok===true?'online': ok===false?'offline': (uAsOff?'offline':'unknown');
    const CLS=(ok,uAsOff=false)=> ok===true?'g': ok===false?'r': (uAsOff?'r':'u');
    const fmtPct=(v)=> (isNaN(v)?'–':(v*100).toFixed(2)+'%');
    const fmtDur=(m)=> m<60?`${m} min`:`${Math.floor(m/60)} h ${m%60} min`;
    const localTime=(iso)=> new Date(iso).toLocaleString();
    const localDate=(iso)=> new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    async function fetchJSON(u){const r=await fetch(u+'?t='+Date.now(),{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json();}
    function setLive(ok,ts){liveDot.className='dot '+(ok===true?'g':ok===false?'r':'u'); liveTxt.textContent=`${STATUS(ok)} • ${ts?localTime(ts):'–'}`;}
    function clear(el){while(el.firstChild)el.removeChild(el.firstChild)}

    function aggregateHourly(history){
      const map=new Map();
      for(const p of history){const d=new Date(p.ts); const key=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}T${String(d.getHours()).padStart(2,'0')}`;
        const m=map.get(key)||{from:p.ts,on:0,off:0,unk:0}; if(p.ok===true)m.on++; else if(p.ok===false)m.off++; else m.unk++; map.set(key,m);}
      return [...map.values()].map(m=>({ts:m.from, ok:m.off>0?false:(m.unk>0?null:true), bucket:'hour'}));
    }
    function aggregateDaily(history){
      const map=new Map();
      for(const p of history){const d=new Date(p.ts); const key=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
        const m=map.get(key)||{from:p.ts,on:0,off:0,unk:0}; if(p.ok===true)m.on++; else if(p.ok===false)m.off++; else m.unk++; map.set(key,m);}
      return [...map.values()].map(m=>({ts:m.from, ok:m.off>0?false:(m.unk>0?null:true), bucket:'day'}));
    }
    function computeStats(points,uAsOff){
      const total=points.length; let on=0,off=0,unk=0;
      for(const p of points){if(p.ok===true)on++; else if(p.ok===false)off++; else unk++;}
      const effOff=off+(uAsOff?unk:0);
      const minutesPer=(total && points[0].bucket==='day')?24*60:60;
      return {total,on,off,unk,uptime: total?(on/(on+effOff)):NaN, downtimeMin: effOff*minutesPer};
    }
    function findIncidents5min(slots){
      const minSlots=Math.ceil(INCIDENT_MIN/SLOT_MIN), out=[]; let i=0;
      while(i<slots.length){ if(slots[i].ok===false){ const s=i; while(i<slots.length&&slots[i].ok===false)i++; const len=i-s; if(len>=minSlots) out.push({from:slots[s].ts,to:slots[i-1].ts,slots:len}); } else i++; }
      return out;
    }
    function renderCompactBars(buckets,uAsOff){
      clear(barsEl); const frag=document.createDocumentFragment(); const H=70;
      buckets.forEach(b=>{const el=document.createElement('div'); el.className='bar '+CLS(b.ok,uAsOff); el.style.height=H+'px';
        el.tabIndex=0; el.addEventListener('mouseenter',ev=>tipShow(ev,b)); el.addEventListener('mousemove',ev=>tipShow(ev,b));
        el.addEventListener('mouseleave',tipHide); el.addEventListener('focus',ev=>tipShow(ev,b)); el.addEventListener('blur',tipHide);
        frag.appendChild(el);
      });
      barsEl.appendChild(frag);
    }
    function tipShow(e,b){
      const isDay=b.bucket==='day';
      TIP_ST.textContent=STATUS(b.ok,unkCtl.checked);
      TIP_TS.textContent=isDay?localDate(b.ts):(localDate(b.ts)+' '+new Date(b.ts).toLocaleTimeString());
      TIP_SRC.textContent='Quelle: History (kompakt)';
      TIP_RANGE.textContent=isDay?'1 Tag':'1 Stunde';
      TIP.style.display='block'; TIP.style.left=(e.clientX)+'px'; TIP.style.top=(e.clientY)+'px';
    }
    function tipHide(){TIP.style.display='none'}

    let timer=null;
    async function load(){
      try{ const live=await fetchJSON(API_LIVE); setLive(live.ok, live.generated); }catch{ setLive(null,null); }
      let hist; try{ hist=await fetchJSON(API_HISTORY); }catch{ fallback(); return; }

      const history=Array.isArray(hist.history)?hist.history:[];
      const svc=hist.service||{};
      svcName.textContent=svc.name||'Minecraft Bedrock';
      svcHost.textContent=[svc.host,svc.port].filter(Boolean).join(':');

      const gen=hist.generated?new Date(hist.generated):null;
      const stale=gen?((Date.now()-gen.getTime())/60000>STALE_MIN):true;
      byId('stale').hidden=!stale;

      const sel=rangeCtl.querySelector('input:checked')?.value||'24h';
      if(sel==='24h'){
        const day=history.slice(-DAY_SLOTS);
        const hours=aggregateHourly(day); renderCompactBars(hours, unkCtl.checked);
        const s=(()=>{let on=0,off=0,unk=0; for(const p of day){if(p.ok===true)on++; else if(p.ok===false)off++; else unk++;}
          const effOff=off+(unkCtl.checked?unk:0); return {on,off,unk,total:day.length,uptime:(on/(on+effOff))||0,down:effOff*SLOT_MIN};})();
        uptimeEl.textContent=fmtPct(s.uptime); dtimeEl.textContent=fmtDur(Math.round(s.down));
        kOnline.textContent=s.on; kOffline.textContent=s.off+(unkCtl.checked?s.unk:0); kUnknown.textContent=(unkCtl.checked?0:s.unk); kPoints.textContent=s.total;
        const inc=findIncidents5min(day);
        if(inc.length){ const ul=document.createElement('ul'); inc.forEach(ev=>{ const li=document.createElement('li'); li.textContent=`Ausfall ${localTime(ev.from)} – ${localTime(ev.to)} (${fmtDur(ev.slots*SLOT_MIN)})`; ul.appendChild(li); });
          incWrap.innerHTML='<h3>Incidents</h3>'; incWrap.appendChild(ul);} else incWrap.innerHTML='';
        metaSrc.textContent='Quelle: History ✓'; footL.textContent='24 hours'; footR.textContent='Today';
      } else {
        const days = sel==='7d' ? aggregateDaily(history.slice(-7*DAY_SLOTS))
                                : aggregateDaily(history.slice(-30*DAY_SLOTS));
        renderCompactBars(days, unkCtl.checked);
        const st = computeStats(days, unkCtl.checked);
        uptimeEl.textContent=fmtPct(st.uptime); dtimeEl.textContent=fmtDur(Math.round(st.downtimeMin));
        kOnline.textContent=st.on; kOffline.textContent=st.off+(unkCtl.checked?st.unk:0); kUnknown.textContent=(unkCtl.checked?0:st.unk); kPoints.textContent=st.total;
        incWrap.innerHTML=''; metaSrc.textContent='Quelle: History ✓';
        footL.textContent = sel==='7d'?'7 days':'30 days'; footR.textContent='Today';
      }
    }
    function computeStats(points,uAsOff){ // für 7d/30d
      let on=0,off=0,unk=0; for(const p of points){if(p.ok===true)on++; else if(p.ok===false)off++; else unk++;}
      const effOff=off+(uAsOff?unk:0); const total=points.length;
      const minutesPer=(total && points[0].bucket==='day')?24*60:60;
      return {on,off,unk,total, uptime: total?(on/(on+effOff)):NaN, downtimeMin: effOff*minutesPer};
    }
    function fallback(){
      clear(barsEl); footL.textContent='–'; footR.textContent='–';
      uptimeEl.textContent='–'; dtimeEl.textContent='–';
      kOnline.textContent='0'; kOffline.textContent='0'; kUnknown.textContent='1'; kPoints.textContent='1';
      incWrap.innerHTML=''; metaSrc.textContent='Quelle: Live (Fallback)';
    }
    function startTimer(){ stopTimer(); timer=setInterval(load,60_000); }
    function stopTimer(){ if(timer){clearInterval(timer); timer=null;} }
    rangeCtl.addEventListener('change', load);
    byId('unkAsOff').addEventListener('change', load);
    byId('auto').addEventListener('change', e=> e.target.checked?startTimer():stopTimer());

    load(); startTimer();
    document.addEventListener('scroll', ()=> TIP.style.display='none', true);
  </script>
</body>
</html>
