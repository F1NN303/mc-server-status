<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Minecraft Bedrock – Status</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0d11; --panel:#0f1320; --line:#1b2231; --line2:#111623;
      --fg:#e6e7eb; --muted:#9aa0a6;
      --g:#19c37d; --r:#ef4444; --o:#f59e0b; --u:#95a3b6; /* orange=degraded, u=unknown(grau) */
      --bar-w:12px; --bar-gap:6px; --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:22px}
    .pill{display:inline-flex;align-items:center;gap:8px;
      background:linear-gradient(180deg,var(--panel),#0b0f1a);
      border:1px solid var(--line); padding:8px 12px;border-radius:999px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--g)} .dot.r{background:var(--r)} .dot.u{background:var(--u)}

    .top-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .seg input{display:none}
    .seg label{padding:6px 10px;font-size:12px;color:var(--muted);cursor:pointer}
    .seg input:checked + label{background:var(--line);color:var(--fg)}
    .toggle{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .toggle input{accent-color:#60a5fa}

    .card{background:linear-gradient(180deg,var(--panel),#0c111c);border:1px solid var(--line);
      border-radius:var(--radius);padding:16px}
    .row-head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .svc{display:flex;flex-direction:column;gap:4px;min-width:240px}
    .svc-name{font-weight:700}
    .svc-host{font-size:12px;color:var(--muted)}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);font-size:12px;background:linear-gradient(180deg,#0c1423,#0a0f1a)}
    .kpi{display:flex;gap:16px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
    .kpi strong{color:var(--fg);font-weight:600}

    .bars-wrap{margin-top:12px}
    .bars{position:relative;display:flex;gap:var(--bar-gap);align-items:flex-end;
      min-height:90px;overflow-x:auto;padding:10px;border-radius:12px;background:linear-gradient(180deg,#0a0e19,#0a0d14)}
    .bar{width:var(--bar-w);flex:0 0 var(--bar-w);border-radius:8px;background:#2a3242;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
    .bar.g{background:var(--g)} .bar.r{background:var(--r)} .bar.o{background:var(--o)} .bar.u{background:var(--u)}
    .bar:focus{outline:2px solid #60a5fa}
    .footline{display:flex;justify-content:space-between;color:var(--muted);
      font-size:12px;margin:6px 4px 0}

    /* Range-spezifische Dichten */
    .bars.mode-24h{min-height:70px}
    .bars.mode-24h .bar{width:4px;flex-basis:4px}     /* 288 feine 5-Min-Bars */
    .bars.mode-7d .bar, .bars.mode-30d .bar{width:12px;flex-basis:12px}

    .legend{display:flex;gap:14px;color:var(--muted);font-size:12px;flex-wrap:wrap;margin-top:8px}
    .lg{display:inline-flex;align-items:center;gap:6px}
    .sq{width:10px;height:10px;border-radius:2px}
    .sq.g{background:var(--g)} .sq.r{background:var(--r)} .sq.o{background:var(--o)} .sq.u{background:var(--u)}

    .tip{position:fixed;pointer-events:none;z-index:70;transform:translate(-50%,-120%);
      background:#0b0f18;border:1px solid var(--line);padding:8px 10px;border-radius:8px;
      font-size:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);display:none;min-width:220px;max-width:90vw}
    .t-line{display:flex;justify-content:space-between;gap:10px}

    .incidents{margin-top:10px}
    .incidents h3{margin:8px 0 6px;font-size:13px;color:var(--muted);font-weight:600}
    .incidents ul{margin:0;padding-left:16px;font-size:12px;color:var(--muted)}
    .incidents li{margin:4px 0}

    .stale{margin-top:8px;font-size:12px;color:#fbbf24}
    .disclaimer{margin-top:8px;font-size:12px;color:var(--muted)}

    @media (max-width:520px){
      h1{font-size:18px}
      .svc-host{font-size:11px}
      .badge{font-size:11px}
      .top-row{gap:8px}
      .seg label{padding:6px 8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header aria-label="Seitenkopf">
      <h1>Minecraft Bedrock – Status</h1>
      <div class="pill" id="live-pill" aria-live="polite" title="Aktueller Live-Status">
        <span class="dot u" id="live-dot" aria-hidden="true"></span>
        <span id="live-txt">Lade Live-Status …</span>
      </div>
    </header>

    <div class="top-row" role="toolbar" aria-label="Ansicht">
      <div class="seg" id="range">
        <input type="radio" name="r" id="r24" value="24h" checked><label for="r24">24 h</label>
        <input type="radio" name="r" id="r7" value="7d"><label for="r7">7 d</label>
        <input type="radio" name="r" id="r30" value="30d"><label for="r30">30 d</label>
      </div>
      <label class="toggle"><input type="checkbox" id="auto" checked /> Live-Refresh (60 s)</label>
      <label class="toggle"><input type="checkbox" id="unkAsOff" /> Unknown als offline werten (nur Anzeige)</label>
    </div>

    <section class="card" aria-label="Service Status">
      <div class="row-head">
        <div class="svc">
          <div class="svc-name" id="svc-name">Minecraft Bedrock</div>
          <div class="svc-host" id="svc-host">–</div>
        </div>
        <div class="badges">
          <div class="badge" title="Uptime der gewählten Zeitspanne">
            <span>Uptime</span><strong id="uptime">–</strong>
          </div>
          <div class="badge" title="Gesamt-Downtime in der Zeitspanne">
            <span>Downtime</span><strong id="downtime">–</strong>
          </div>
        </div>
      </div>

      <div class="kpi" id="kpi">
        <div><strong id="kpi-online">–</strong> online</div>
        <div><strong id="kpi-offline">–</strong> offline</div>
        <div><strong id="kpi-unknown">–</strong> unknown</div>
        <div><strong id="kpi-points">–</strong> Punkte</div>
      </div>

      <div class="bars-wrap">
        <div id="bars" class="bars mode-24h" role="group" aria-label="Status-Zeitachse"></div>
        <div class="footline">
          <span id="foot-left">24 hours</span>
          <span id="foot-right">Today</span>
        </div>
      </div>

      <div class="legend" aria-hidden="true">
        <span class="lg"><span class="sq g"></span> online</span>
        <span class="lg"><span class="sq r"></span> offline</span>
        <span class="lg"><span class="sq o"></span> eingeschränkt</span>
        <span class="lg"><span class="sq u"></span> unbekannt</span>
        <span class="lg">• 1 Balken = 5 Min (24 h) • 1 Balken = 1 Tag (7 d/30 d) • <span id="meta-src">Quelle: History</span></span>
      </div>

      <p class="disclaimer">Diese Daten sind Schätzungen bzw. Pings an den Server und können nicht zu 100&nbsp;% stimmen.</p>

      <div class="incidents" id="inc"></div>
      <div class="stale" id="stale" hidden>Hinweis: History ist älter als 30 Min. Live-Pille zeigt aktuellen Zustand.</div>
    </section>
  </div>

  <div class="tip" id="tip">
    <div class="t-line"><span id="tip-status">–</span><span id="tip-ts">–</span></div>
    <div class="t-line"><span id="tip-src">–</span><span id="tip-range">–</span></div>
  </div>

  <script>
    // Endpunkte
    const API_HISTORY='/api/history';
    const API_LIVE='/api/bedrock';

    // Konstanten
    const SLOT_MIN=5, DAY_SLOTS=(24*60)/SLOT_MIN, STALE_MIN=30, INCIDENT_MIN=15;

    // DOM refs
    const $ = id => document.getElementById(id);
    const barsEl=$('bars'), rangeCtl=$('range'), unkCtl=$('unkAsOff'), autoCtl=$('auto');
    const liveDot=$('live-dot'), liveTxt=$('live-txt'), svcName=$('svc-name'), svcHost=$('svc-host');
    const uptimeEl=$('uptime'), dtimeEl=$('downtime'), kOnline=$('kpi-online'), kOffline=$('kpi-offline'), kUnknown=$('kpi-unknown'), kPoints=$('kpi-points');
    const footL=$('foot-left'), footR=$('foot-right'), metaSrc=$('meta-src'), incWrap=$('inc'), staleEl=$('stale');
    const TIP=$('tip'), TIP_TS=$('tip-ts'), TIP_ST=$('tip-status'), TIP_SRC=$('tip-src'), TIP_RANGE=$('tip-range');

    // Helpers
    const STATUS=(ok,uAsOff=false)=> ok===true?'online': ok===false?'offline': (uAsOff?'offline':'unknown');
    const CLS=(ok,uAsOff=false)=> ok===true?'g': ok===false?'r': (uAsOff?'r':'u');
    const fmtPct=v=> (isNaN(v)?'–':(v*100).toFixed(2)+'%');
    const fmtDur=m=> m<60?`${m} min`:`${Math.floor(m/60)} h ${m%60} min`;
    const localTime=iso=> new Date(iso).toLocaleString();
    const localDate=iso=> new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));

    async function fetchJSON(u){const r=await fetch(u+'?t='+Date.now(),{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json();}
    function clear(el){while(el.firstChild)el.removeChild(el.firstChild)}
    function setLive(ok,ts){liveDot.className='dot '+(ok===true?'g':ok===false?'r':'u'); liveTxt.textContent=`${STATUS(ok)} • ${ts?localTime(ts):'–'}`;}

    // Klassifikation Tagesbalken (rot/orange/grün)
    function classifyDay(on,off,unk,uAsOff){
      const total=on+off+unk||1;
      const offEff=off+(uAsOff?unk:0);
      const offPct=offEff/total, unkPct=unk/total;
      if(offPct>=0.5) return 'r';                         // viel offline
      if(offEff>0 || (!uAsOff && unkPct>=0.2)) return 'o';// kleine Ausfälle / viel unknown
      return 'g';
    }

    // Aggregation
    function aggregateDaily(history){
      const map=new Map();
      for(const p of history){
        const d=new Date(p.ts);
        const key=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
        const m=map.get(key)||{from:p.ts,on:0,off:0,unk:0,total:0};
        if(p.ok===true)m.on++; else if(p.ok===false)m.off++; else m.unk++;
        m.total++; m.to=p.ts;
        map.set(key,m);
      }
      return [...map.values()].map(m=>({...m, bucket:'day'}));
    }

    function findIncidents5min(slots){
      const minSlots=Math.ceil(INCIDENT_MIN/SLOT_MIN), out=[]; let i=0;
      while(i<slots.length){ if(slots[i].ok===false){const s=i; while(i<slots.length&&slots[i].ok===false)i++; const len=i-s; if(len>=minSlots) out.push({from:slots[s].ts,to:slots[i-1].ts,slots:len});} else i++; }
      return out;
    }

    // Render
    function renderFine24h(slots,uAsOff){
      clear(barsEl); barsEl.classList.remove('mode-7d','mode-30d'); barsEl.classList.add('mode-24h');
      const frag=document.createDocumentFragment();
      for(const p of slots){
        const el=document.createElement('div');
        el.className='bar '+CLS(p.ok,uAsOff);
        el.style.height='60px';
        el.tabIndex=0;
        el.addEventListener('mouseenter',ev=>tipShow(ev,{bucket:'5m',ts:p.ts,ok:p.ok,src:'History'}));
        el.addEventListener('mousemove',ev=>tipShow(ev,{bucket:'5m',ts:p.ts,ok:p.ok,src:'History'}));
        el.addEventListener('mouseleave',tipHide);
        el.addEventListener('focus',ev=>tipShow(ev,{bucket:'5m',ts:p.ts,ok:p.ok,src:'History'}));
        el.addEventListener('blur',tipHide);
        frag.appendChild(el);
      }
      barsEl.appendChild(frag);
      footL.textContent='24 hours'; footR.textContent='Today';
    }

    function renderDays(days,uAsOff, labelLeft){
      clear(barsEl); barsEl.classList.remove('mode-24h'); barsEl.classList.add(labelLeft==='7 days'?'mode-7d':'mode-30d');
      const frag=document.createDocumentFragment();
      for(const d of days){
        const color=classifyDay(d.on,d.off,d.unk,uAsOff); // g/o/r
        const el=document.createElement('div');
        el.className='bar '+(color==='o'?'o':color); // map
        el.style.height='70px';
        el.tabIndex=0;
        el.addEventListener('mouseenter',ev=>tipShowDay(ev,d,uAsOff));
        el.addEventListener('mousemove',ev=>tipShowDay(ev,d,uAsOff));
        el.addEventListener('mouseleave',tipHide);
        el.addEventListener('focus',ev=>tipShowDay(ev,d,uAsOff));
        el.addEventListener('blur',tipHide);
        frag.appendChild(el);
      }
      barsEl.appendChild(frag);
      footL.textContent=labelLeft; footR.textContent='Today';
    }

    function tipShow(e,b){
      TIP_ST.textContent=STATUS(b.ok, unkCtl.checked);
      TIP_TS.textContent = b.bucket==='5m' ? localTime(b.ts) : localDate(b.ts);
      TIP_SRC.textContent='Quelle: '+(b.src||'History');
      TIP_RANGE.textContent= b.bucket==='5m' ? '5 Minuten' : (b.bucket==='day'?'1 Tag':'');
      TIP.style.display='block';
      const x=clamp(e.clientX, 100, window.innerWidth-100);
      const y=clamp(e.clientY, 80, window.innerHeight-40);
      TIP.style.left=x+'px'; TIP.style.top=y+'px';
    }
    function tipShowDay(e,d,uAsOff){
      const total=d.total||1;
      const offEff=d.off+(uAsOff?d.unk:0);
      const onPct=(d.on/total)*100, offPct=(offEff/total)*100, unkPct=(d.unk/total)*100;
      TIP_ST.textContent = (classifyDay(d.on,d.off,d.unk,uAsOff)==='g'?'online': classifyDay(d.on,d.off,d.unk,uAsOff)==='o'?'eingeschränkt':'offline');
      TIP_TS.textContent = localDate(d.from);
      TIP_SRC.textContent= 'Quelle: History (Tag)';
      TIP_RANGE.textContent= '1 Tag • on ' + onPct.toFixed(1) + '%, off ' + offPct.toFixed(1) + '%' + (uAsOff?' (inkl. unknown)':'') + (uAsOff?'': `, unknown ${unkPct.toFixed(1)}%`);
      TIP.style.display='block';
      const x=clamp(e.clientX, 100, window.innerWidth-100);
      const y=clamp(e.clientY, 80, window.innerHeight-40);
      TIP.style.left=x+'px'; TIP.style.top=y+'px';
    }
    function tipHide(){ TIP.style.display='none' }

    // KPIs exakt
    function kpisFrom5min(slots,uAsOff){
      let on=0,off=0,unk=0;
      for(const p of slots){ if(p.ok===true) on++; else if(p.ok===false) off++; else unk++; }
      const effOff = off + (uAsOff?unk:0);
      return {
        total: slots.length,
        on, off, unk,
        uptime: (on/(on+effOff)) || 0,
        downtimeMin: effOff * SLOT_MIN
      };
    }
    function kpisFromDays(days,uAsOff){
      let on=0,off=0,unk=0, totalSlots=0;
      for(const d of days){ on+=d.on; off+=d.off; unk+=d.unk; totalSlots+=d.total; }
      const effOff = off + (uAsOff?unk:0);
      return {
        total: days.length,
        onDays: days.filter(d=>classifyDay(d.on,d.off,d.unk,uAsOff)==='g').length,
        uptime: ((totalSlots - effOff)/totalSlots) || 0,
        downtimeMin: effOff * SLOT_MIN,
        raw:{on,off,unk}
      };
    }

    // Main
    let timer=null;

    async function load(){
      // Live-Pille
      try{ const live=await fetchJSON(API_LIVE); setLive(live.ok,live.generated); }catch{ setLive(null,null); }

      let hist;
      try{ hist=await fetchJSON(API_HISTORY); }
      catch{ fallback(); return; }

      const history=Array.isArray(hist.history)?hist.history:[];
      const svc=hist.service||{};
      $('svc-name').textContent=svc.name||'Minecraft Bedrock';
      $('svc-host').textContent=[svc.host,svc.port].filter(Boolean).join(':');

      // Stale
      const gen = hist.generated? new Date(hist.generated): null;
      const stale = gen ? ((Date.now()-gen.getTime())/60000 > STALE_MIN) : true;
      staleEl.hidden = !stale;

      const mode = (rangeCtl.querySelector('input:checked')?.value)||'24h';
      const uAsOff = unkCtl.checked;

      if(mode==='24h'){
        const last = history.slice(-DAY_SLOTS);                     // 288 × 5-Min
        renderFine24h(last, uAsOff);
        const s = kpisFrom5min(last, uAsOff);
        uptimeEl.textContent = fmtPct(s.uptime);
        dtimeEl.textContent  = fmtDur(Math.round(s.downtimeMin));
        kOnline.textContent  = s.on;
        kOffline.textContent = s.off + (uAsOff ? s.unk : 0);
        kUnknown.textContent = uAsOff ? 0 : s.unk;
        kPoints.textContent  = s.total;

        // Incidents (24h)
        const inc = findIncidents5min(last);
        if(inc.length){
          const ul=document.createElement('ul');
          inc.forEach(ev=>{ const li=document.createElement('li'); li.textContent=`Ausfall ${localTime(ev.from)} – ${localTime(ev.to)} (${fmtDur(ev.slots*SLOT_MIN)})`; ul.appendChild(li); });
          incWrap.innerHTML='<h3>Incidents</h3>'; incWrap.appendChild(ul);
        } else incWrap.innerHTML='';

        metaSrc.textContent='Quelle: History ✓';

      } else {
        const span = mode==='7d'? 7*DAY_SLOTS : 30*DAY_SLOTS;
        const last = history.slice(-span);
        const days = aggregateDaily(last);
        renderDays(days, uAsOff, mode==='7d'?'7 days':'30 days');
        const s = kpisFromDays(days, uAsOff);
        uptimeEl.textContent = fmtPct(s.uptime);
        dtimeEl.textContent  = fmtDur(Math.round(s.downtimeMin));
        // Für KPIs: wir zeigen die Slot-Zahlen (exakt), nicht „Tage offline“
        kOnline.textContent  = s.raw.on;
        kOffline.textContent = s.raw.off + (uAsOff ? s.raw.unk : 0);
        kUnknown.textContent = uAsOff ? 0 : s.raw.unk;
        kPoints.textContent  = last.length;
        incWrap.innerHTML=''; // bei Tagesansicht keine feingranularen Incidents
        metaSrc.textContent='Quelle: History ✓';
      }
    }

    function fallback(){
      clear(barsEl); barsEl.classList.add('mode-24h'); footL.textContent='–'; footR.textContent='–';
      uptimeEl.textContent='–'; dtimeEl.textContent='–';
      kOnline.textContent='0'; kOffline.textContent='0'; kUnknown.textContent='1'; kPoints.textContent='1';
      incWrap.innerHTML=''; metaSrc.textContent='Quelle: Live (Fallback)';
    }

    function startTimer(){ stopTimer(); timer=setInterval(load,60_000); }
    function stopTimer(){ if(timer){clearInterval(timer); timer=null;} }

    rangeCtl.addEventListener('change', e=>{
      const v=e.target.value;
      barsEl.classList.toggle('mode-24h', v==='24h');
      barsEl.classList.toggle('mode-7d',  v==='7d');
      barsEl.classList.toggle('mode-30d', v==='30d');
      footL.textContent= v==='24h'?'24 hours': (v==='7d'?'7 days':'30 days');
      footR.textContent='Today';
      load();
    });
    unkCtl.addEventListener('change', load);
    autoCtl.addEventListener('change', ()=> autoCtl.checked ? startTimer() : stopTimer());

    // Init
    load(); startTimer();

    // Tooltip Hide bei Scroll & Clamping
    document.addEventListener('scroll', ()=> TIP.style.display='none', true);
    window.addEventListener('resize', ()=> TIP.style.display='none');
  </script>
</body>
</html>
