<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="robots" content="noindex, nofollow"/>
<title>Minecraft Bedrock ‚Äì Status</title>
<meta name="color-scheme" content="dark light"/>
<link rel="icon" href="/favicon.ico">
<style>
:root{
  --bg:#0b0d11; --panel:#0f1320; --line:#1b2231;
  --fg:#e6e7eb; --muted:#9aa0a6;
  --g:#19c37d; --r:#ef4444; --o:#f59e0b; --u:#95a3b6;
  --accent:#93c5fd;
  --radius:12px; --cols:288;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:28px auto;padding:0 16px}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:16px}
h1{margin:0;font-size:22px}
.pill{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,var(--panel),#0b0f1a);
  border:1px solid var(--line);padding:8px 12px;border-radius:999px;font-size:13px}
.dot{width:10px;height:10px;border-radius:50%}
.dot.g{background:var(--g)} .dot.r{background:var(--r)} .dot.u{background:var(--u)}
.top-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px}
.seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.seg input{display:none}
.seg label{padding:6px 10px;font-size:12px;color:var(--muted);cursor:pointer}
.seg input:checked + label{background:var(--line);color:var(--fg)}
.toggle{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
.toggle input{accent-color:#60a5fa}
.badge,.btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
  border:1px solid var(--line);font-size:12px;background:linear-gradient(180deg,#0c1423,#0a0f1a);color:var(--fg)}
.btn{cursor:pointer}

.card{background:linear-gradient(180deg,var(--panel),#0c111c);border:1px solid var(--line);
  border-radius:var(--radius);padding:16px}
.row-head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.svc{display:flex;flex-direction:column;gap:4px;min-width:240px}
.svc-name{font-weight:700}
.svc-host{font-size:12px;color:var(--muted)}
.badges{display:flex;gap:8px;flex-wrap:wrap}
.kpi{display:flex;gap:16px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
.kpi strong{color:var(--fg);font-weight:600}

/* Bars */
.bars-wrap{margin-top:12px;position:relative}
.bars{
  position:relative; display:grid;
  grid-template-columns: repeat(var(--cols), minmax(3px, 1fr));
  gap:6px; align-items:end; min-height:96px;
  padding:10px; border-radius:12px;
  background:linear-gradient(180deg,#0a0e19,#0a0d14);
  overflow:hidden; touch-action: manipulation;
}
.bars.mode-24h{min-height:80px; gap:4px}
.bar{
  height:64px;border-radius:8px;background:#2a3242;box-shadow:inset 0 0 0 1px rgba(0,0,0,.25);
  position:relative;
}
.bar::after{content:""; position:absolute; inset:-8px; border-radius:10px;} /* gr√∂√üere Touch-Fl√§che */
.bar.g{background:var(--g)} .bar.r{background:var(--r)} .bar.o{background:var(--o)} .bar.u{background:var(--u)}
.hoverline{position:absolute;top:10px;bottom:10px;width:2px;background:#ffffff40;pointer-events:none;display:none}
.skeleton{animation:shimmer 1.2s infinite;background:linear-gradient(90deg,#0f1422 0%,#131a2a 50%,#0f1422 100%);background-size:200% 100%}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.footline{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin:6px 4px 0}
.legend{display:flex;gap:14px;color:var(--muted);font-size:12px;flex-wrap:wrap;margin-top:8px}
.lg{display:inline-flex;align-items:center;gap:6px}
.sq{width:10px;height:10px;border-radius:2px}
.sq.g{background:var(--g)} .sq.r{background:var(--r)} .sq.o{background:var(--o)} .sq.u{background:var(--u)}
.disclaimer{margin-top:8px;font-size:12px;color:var(--muted)}
.incidents{margin-top:10px}
.incidents h3{margin:8px 0 6px;font-size:13px;color:var(--muted);font-weight:600}
.incidents ul{margin:0;padding-left:16px;font-size:12px;color:var(--muted)}
.incidents li{margin:4px 0}
.maint{margin-top:10px;font-size:12px;color:#fbbf24} /* Wartung ‚Äì unten */

/* Heatmap */
.heat{margin-top:18px}
.heat h3{margin:0 0 8px;font-size:13px;color:var(--muted);font-weight:600}
.hm{display:grid;grid-template-columns:repeat(13,1fr);gap:4px}
.hm .cell{height:12px;border-radius:3px;background:#2a3242}
.hm .g{background:var(--g)} .hm .o{background:var(--o)} .hm .r{background:var(--r)} .hm .u{background:var(--u)}
.hm .label{grid-column:span 13;font-size:11px;color:var(--muted);margin-top:6px}

/* News */
.grid1{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
.news li{margin:6px 0}

/* Mobile */
@media (max-width:520px){
  h1{font-size:18px}
  .svc-host,.badge{font-size:11px}
  .seg label{padding:6px 8px}
  .bars{gap:5px}
  .bars.mode-24h{gap:5px}
  .bar{height:68px}
  .bar::after{inset:-12px} /* noch gr√∂√üere Touch-Zone auf Handy */
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Minecraft Bedrock ‚Äì Status</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button id="copyBtn" class="btn" title="IP kopieren">üìã Kopiere IP</button>
      <button id="themeBtn" class="btn" title="Theme umschalten">üåì Theme</button>
      <div class="pill" id="live-pill" aria-live="polite">
        <span class="dot u" id="live-dot"></span>
        <span id="live-txt">Lade Live-Status ‚Ä¶</span>
      </div>
    </div>
  </header>

  <div class="top-row" role="toolbar">
    <div class="seg" id="range">
      <input type="radio" name="r" id="r24" value="24h" checked><label for="r24">24 h</label>
      <input type="radio" name="r" id="r7" value="7d"><label for="r7">7 d</label>
      <input type="radio" name="r" id="r30" value="30d"><label for="r30">30 d</label>
    </div>
    <label class="toggle"><input type="checkbox" id="auto" checked/> Live-Refresh (60 s)</label>
    <a href="./ping.html" class="badge" title="Ping &amp; Latenz">üîß Ping &amp; Latenz</a>
    <button id="btn-csv" class="badge" title="CSV exportieren" style="cursor:pointer">‚¨á CSV</button>
  </div>

  <section class="card">
    <div class="row-head">
      <div class="svc">
        <div class="svc-name" id="svc-name">Minecraft Bedrock</div>
        <div class="svc-host" id="svc-host">‚Äì</div>
      </div>
      <div class="badges">
        <div class="badge"><span>Uptime</span><strong id="uptime">‚Äì</strong></div>
        <div class="badge"><span>Downtime</span><strong id="downtime">‚Äì</strong></div>
        <div class="badge"><span>Players</span><strong id="players">‚Äî</strong></div>
      </div>
    </div>

    <div class="kpi">
      <div><strong id="kpi-online">‚Äì</strong> online</div>
      <div><strong id="kpi-offline">‚Äì</strong> offline</div>
      <div><strong id="kpi-unknown">‚Äì</strong> unknown</div>
      <div><strong id="kpi-points">‚Äì</strong> Punkte</div>
    </div>

    <div class="bars-wrap">
      <div id="bars" class="bars mode-24h" role="group" aria-label="Zeitachse"></div>
      <div id="hoverline" class="hoverline"></div>
      <div class="footline"><span id="foot-left">24 hours</span><span id="foot-right">Today</span></div>
    </div>

    <div class="legend">
      <span class="lg"><span class="sq g"></span> online</span>
      <span class="lg"><span class="sq r"></span> offline</span>
      <span class="lg"><span class="sq o"></span> eingeschr√§nkt</span>
      <span class="lg"><span class="sq u"></span> unbekannt</span>
      <span class="lg">‚Ä¢ <span id="legend-interval">1 Balken = 1 Probe (variable Minuten)</span> ‚Ä¢ <span id="meta-src">Quelle: History</span></span>
    </div>

    <p class="disclaimer">Diese Daten sind Sch√§tzungen bzw. Pings an den Server und k√∂nnen nicht zu 100&nbsp;% stimmen.</p>

    <div class="grid1">
      <!-- News -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Server News</strong>
          <a href="./rules.html" class="badge">üìú Regeln</a>
        </div>
        <ul id="news" class="news" aria-live="polite"></ul>
      </div>
    </div>

    <div class="incidents" id="inc"></div>
    <div class="maint" id="maint" hidden>‚öôÔ∏è N√§chste Wartung: <span id="maintTxt">‚Äì</span></div>

    <div class="heat">
      <h3>Kalender-Heatmap (letzte 90 Tage)</h3>
      <div class="hm" id="heatmap"></div>
    </div>
  </section>
</div>

<div class="tip" id="tip" style="position:fixed;pointer-events:none;z-index:70;transform:translate(-50%,-120%);
  background:#0b0f18;border:1px solid var(--line);padding:8px 10px;border-radius:8px;
  font-size:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);display:none;min-width:220px;max-width:90vw">
  <div class="t-line" style="display:flex;justify-content:space-between;gap:10px"><span id="tip-status">‚Äì</span><span id="tip-ts">‚Äì</span></div>
  <div class="t-line" style="display:flex;justify-content:space-between;gap:10px"><span id="tip-src">‚Äì</span><span id="tip-range">‚Äì</span></div>
</div>

<script>
/* === Konfig / Endpoints === */
const HOST="important-instrumentation.gl.at.ply.gg"; const PORT=18232; const COPY_STR=`${HOST}:${PORT}`;
const API_HISTORY='/api/history';
const API_LIVE='/api/bedrock';
const API_INCIDENTS='/secret-status-bf6a3e31/incidents.json';
const API_NEWS='/data/news.json';
const API_PLAYERS='/data/players.json'; // nur Fallback
const SLOT_MIN=5, DAY_MS=86400000, STALE_MIN=30, INCIDENT_MIN=15;

/* DOM refs */
const $=id=>document.getElementById(id);
const barsEl=$('bars'), hoverLine=$('hoverline'), rangeCtl=$('range'), autoCtl=$('auto');
const liveDot=$('live-dot'), liveTxt=$('live-txt'), svcName=$('svc-name'), svcHost=$('svc-host');
const uptimeEl=$('uptime'), dtimeEl=$('downtime'), kOnline=$('kpi-online'), kOffline=$('kpi-offline'), kUnknown=$('kpi-unknown'), kPoints=$('kpi-points');
const metaSrc=$('meta-src'), incWrap=$('inc'), heatEl=$('heatmap'), newsEl=$('news');
const TIP=$('tip'), TIP_TS=$('tip-ts'), TIP_ST=$('tip-status'), TIP_SRC=$('tip-src'), TIP_RANGE=$('tip-range');
const btnCSV=$('btn-csv'), copyBtn=$('copyBtn'), themeBtn=$('themeBtn');
const playersEl=$('players'); const maintEl=$('maint'), maintTxt=$('maintTxt');

/* Utils */
const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;
const clamp=(x,min,max)=>Math.max(min,Math.min(max,x));
const fmtPct=v=> (isNaN(v)?'‚Äî':(v*100).toFixed(2)+'%');
const fmtDur=m=> m<60?`${m} min`:`${Math.floor(m/60)} h ${m%60} min`;
const localTime=iso=> new Date(iso).toLocaleString();
const localDate=iso=> new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
const statusClass = ok => ok===true?'g': ok===false?'r':'u';
const statusText  = ok => ok===true?'online': ok===false?'offline':'unbekannt';
const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
const endOfDay   = d => { const x=new Date(d); x.setHours(23,59,59,999); return x; };
async function fetchJSON(u, opts={}){ const r=await fetch(u,{cache:'no-store',...opts}); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
function clear(el){while(el.firstChild)el.removeChild(el.firstChild)}
function setLive(ok,ts){liveDot.className='dot '+statusClass(ok); liveTxt.textContent=`${statusText(ok)} ‚Ä¢ ${ts?localTime(ts):'‚Äî'}`;}

/* Theme Toggle */
(function(){
  const key='theme';
  const apply=t=>{ document.documentElement.style.colorScheme = (t==='light'?'light':'dark'); };
  let cur=localStorage.getItem(key)||'auto';
  if(cur==='auto') apply(matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'); else apply(cur);
  themeBtn.addEventListener('click', ()=>{
    cur = (cur==='dark'?'light': (cur==='light'?'auto':'dark'));
    localStorage.setItem(key,cur);
    apply(cur==='auto'?(matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'):cur);
    themeBtn.textContent = 'üåì ' + (cur==='auto'?'Auto':(cur==='light'?'Light':'Dark'));
  });
  themeBtn.textContent = 'üåì ' + (cur==='auto'?'Auto':(cur==='light'?'Light':'Dark'));
})();

/* Copy IP */
copyBtn.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(COPY_STR); copyBtn.textContent='‚úÖ Kopiert!'; setTimeout(()=>copyBtn.textContent='üìã Kopiere IP',1400); }
  catch{ prompt('Kopiere diese IP:', COPY_STR); }
});

/* Caching / Params */
const cacheKey=(range)=>`hist:${range}`;
async function loadHistory(range){
  const qs=`?range=${encodeURIComponent(range)}`;
  try{ const d=await fetchJSON(API_HISTORY+qs); localStorage.setItem(cacheKey(range),JSON.stringify({t:Date.now(),d})); return d; }
  catch(e){
    try{ const d=await fetchJSON(API_HISTORY); localStorage.setItem(cacheKey(range),JSON.stringify({t:Date.now(),d})); return d; }
    catch(err){ const raw=localStorage.getItem(cacheKey(range)); if(raw) return JSON.parse(raw).d; throw err; }
  }
}
function getParams(){ const p=new URLSearchParams(location.search); return { range:p.get('range')||'24h', live:p.get('live')!=='0' }; }
function setInitialFromParams(){
  const {range, live}=getParams();
  (document.getElementById(range==='7d'?'r7':(range==='30d'?'r30':'r24'))||{}).checked=true;
  autoCtl.checked = !!live;
}

/* Intervals */
function toIntervals(points, nowIso){
  const arr=[...points].sort((a,b)=>new Date(a.ts)-new Date(b.ts));
  const out=[];
  for(let i=0;i<arr.length;i++){
    const from=new Date(arr[i].ts);
    const to=new Date(i<arr.length-1?arr[i+1].ts:(nowIso||new Date().toISOString()));
    const mins=Math.max(1, Math.round((to-from)/60000));
    out.push({from:arr[i].ts,to:to.toISOString(),ok:arr[i].ok,mins});
  }
  return out;
}
function kpisFromIntervals(intervals){
  let on=0,off=0,unk=0;
  for(const it of intervals){ if(it.ok===true) on+=it.mins; else if(it.ok===false) off+=it.mins; else unk+=it.mins; }
  return {on,off,unk,total:on+off+unk, points: intervals.length};
}
function aggregateByDays(intervals, n){
  const days=[];
  const today = startOfDay(new Date());
  for(let i=n-1;i>=0;i--){
    const dStart = new Date(today.getTime() - i*DAY_MS);
    const dEnd   = endOfDay(dStart);
    const bucket = {from:dStart.toISOString(),on:0,off:0,unk:0,total:0};
    for(const it of intervals){
      const s=Math.max(new Date(it.from).getTime(), dStart.getTime());
      const e=Math.min(new Date(it.to).getTime(),   dEnd.getTime());
      const mins = Math.max(0, Math.round((e-s)/60000));
      if(mins>0){
        if(it.ok===true) bucket.on+=mins; else if(it.ok===false) bucket.off+=mins; else bucket.unk+=mins;
        bucket.total+=mins;
      }
    }
    days.push(bucket);
  }
  return days;
}
function classifyDay(d){ const total=d.total||1, offPct=d.off/total, unkPct=d.unk/total;
  if(offPct>=0.5) return 'r'; if(d.off>0 || unkPct>=0.2) return 'o'; return 'g'; }

/* Incidents + Wartung */
async function loadExternalIncidentReasons(){ try{ return await fetchJSON(API_INCIDENTS); } catch { return []; } }
function overlap(aFrom,aTo,bFrom,bTo){ return (new Date(aFrom)<=new Date(bTo)) && (new Date(bFrom)<=new Date(aTo)); }
async function renderIncidents(intervals){
  const reasons=await loadExternalIncidentReasons();
  const incidents=[];
  let i=0; while(i<intervals.length){
    if(intervals[i].ok===false){
      let from=intervals[i].from, mins=0, j=i;
      while(j<intervals.length && intervals[j].ok===false){ mins+=intervals[j].mins; j++; }
      if(mins>=15) incidents.push({from,to:intervals[j-1].to,mins});
      i=j;
    } else i++;
  }
  if(!incidents.length){ incWrap.innerHTML=''; return; }

  const ul=document.createElement('ul');
  incidents.forEach(ev=>{
    const match=reasons.find(r=>overlap(ev.from,ev.to,r.from,r.to));
    const isPlanned = !!(match && match.planned);
    const li=document.createElement('li');
    li.textContent = `${isPlanned?'‚öôÔ∏è Geplante Wartung':'Ausfall'} ${localTime(ev.from)} ‚Äì ${localTime(ev.to)} (${fmtDur(Math.round(ev.mins))})` + (match?` ‚Äì Grund: ${match.reason}`:'');
    ul.appendChild(li);
  });
  incWrap.innerHTML='<h3>Incidents</h3>'; incWrap.appendChild(ul);

  // n√§chste geplante Wartung (unten)
  const upcoming = reasons.filter(x=>x.planned && new Date(x.from).getTime() > Date.now()).sort((a,b)=>new Date(a.from)-new Date(b.from))[0];
  if(upcoming){
    maintTxt.textContent = `${localDate(upcoming.from)} ${new Date(upcoming.from).toLocaleTimeString()} ‚Äì ${upcoming.reason}`;
    maintEl.hidden = false;
  } else { maintEl.hidden = true; }
}

/* News */
async function renderNews(){
  try{
    const list = await fetchJSON(API_NEWS);
    const last = (Array.isArray(list)? list:[]).slice(-6).reverse();
    if(!last.length){ newsEl.innerHTML = '<li class="muted">Keine News</li>'; return; }
    newsEl.innerHTML = last.map(n=>`<li>‚Ä¢ ${new Date(n.ts).toLocaleString()}: ${n.text}</li>`).join('');
  }catch{ newsEl.innerHTML='<li class="muted">News nicht verf√ºgbar</li>'; }
}

/* Hoverline Desktop + Tooltip */
if(!isTouch){
  barsEl.addEventListener('mousemove',e=>{
    const rect=barsEl.getBoundingClientRect();
    const x=clamp(e.clientX-rect.left,0,rect.width);
    const cols=parseInt(getComputedStyle(barsEl).getPropertyValue('--cols'))||1;
    const gap=parseFloat(getComputedStyle(barsEl).gap)||0;
    const cellW=(rect.width - gap*(cols-1))/cols;
    const idx=Math.round(x / (cellW+gap));
    const snapped = clamp(idx*(cellW+gap), 0, rect.width);
    $('hoverline').style.left=snapped+'px'; $('hoverline').style.display='block';
  });
  barsEl.addEventListener('mouseleave',()=>{$('hoverline').style.display='none'; hideTip();});
}
function showTip(e,range,ok,ts,src){
  TIP_ST.textContent=statusText(ok);
  TIP_TS.textContent=(range==='1 Tag')?localDate(ts):localTime(ts);
  TIP_SRC.textContent=src||''; TIP_RANGE.textContent=range;
  TIP.style.display='block';
  const clientX = e.clientX ?? (e.pageX - window.scrollX);
  const clientY = e.clientY ?? (e.pageY - window.scrollY);
  TIP.style.left=clamp(clientX,100,window.innerWidth-100)+'px';
  TIP.style.top =clamp(clientY,80,window.innerHeight-40)+'px';
}
function hideTip(){ TIP.style.display='none'; }
document.addEventListener('touchstart', (ev)=>{ if(!ev.target.closest('.bar')) hideTip(); }, {passive:true});

/* Rendering Bars */
function setCols(n){ barsEl.style.setProperty('--cols', Math.max(1,n)); }
function renderSkeleton(n=60){ clear(barsEl); barsEl.className='bars mode-24h'; setCols(n);
  const f=document.createDocumentFragment(); for(let i=0;i<n;i++){const el=document.createElement('div'); el.className='bar skeleton'; f.appendChild(el);} barsEl.appendChild(f); }
function render24h(intervals){
  clear(barsEl); barsEl.className='bars mode-24h'; setCols(intervals.length);
  const f=document.createDocumentFragment();
  intervals.forEach(p=>{
    const el=document.createElement('div'); el.className='bar '+statusClass(p.ok);
    const durTxt = p.mins===1?'1 Minute':`${p.mins} Minuten`;
    const show = ev=>showTip((ev.touches?ev.touches[0]:ev),durTxt,p.ok,p.from,'History');
    el.addEventListener('mouseenter',show); el.addEventListener('mousemove',show);
    el.addEventListener('mouseleave',hideTip); el.addEventListener('touchstart',show,{passive:true});
    f.appendChild(el);
  }); barsEl.appendChild(f);
}
function renderDays(days){
  clear(barsEl); barsEl.className='bars'; setCols(days.length);
  const f=document.createDocumentFragment();
  days.forEach(d=>{
    const cls=classifyDay(d); const el=document.createElement('div'); el.className='bar '+cls;
    const on=(d.on/d.total||0)*100, off=(d.off/d.total||0)*100, unk=(d.unk/d.total||0)*100;
    const state = cls==='r'?false:(cls==='g'?true:null);
    const srcTxt=`History ‚Ä¢ on ${on.toFixed(1)}% ‚Ä¢ off ${off.toFixed(1)}% ‚Ä¢ unknown ${unk.toFixed(1)}%`;
    const show = ev=>showTip((ev.touches?ev.touches[0]:ev),'1 Tag',state,d.from,srcTxt);
    el.addEventListener('mouseenter',show); el.addEventListener('mousemove',show);
    el.addEventListener('mouseleave',hideTip); el.addEventListener('touchstart',show,{passive:true});
    f.appendChild(el);
  }); barsEl.appendChild(f);
}

/* CSV Export */
btnCSV.addEventListener('click', async ()=>{
  const range = rangeCtl.querySelector('input:checked')?.value||'24h';
  let data; try{ data=await loadHistory(range); }catch{ alert('Keine History verf√ºgbar'); return; }
  const hist=Array.isArray(data.history)?data.history:[]; const generated=data.generated||new Date().toISOString();
  const intervals=toIntervals(hist,generated);
  let subset=[];
  if(range==='24h'){ const since=Date.now()-DAY_MS; subset=intervals.filter(i=>new Date(i.from).getTime()>=since); }
  else { const n=(range==='7d')?7:30; const since=startOfDay(new Date(Date.now()-(n-1)*DAY_MS)).toISOString();
         subset=intervals.filter(i=>new Date(i.to).getTime()>=new Date(since).getTime()); }
  const rows=[['from','to','ok','minutes']].concat(subset.map(i=>[i.from,i.to, i.ok, i.mins]));
  const csv = rows.map(r=>r.map(s=>`"${String(s).replaceAll('"','""')}"`).join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`status_${range}.csv`; a.click();
});

/* Haupt-Load */
async function load(range){
  renderSkeleton(60);

  // Live & Players
  try{
    const live=await fetchJSON(API_LIVE+'?t='+Date.now());
    setLive(live.ok,live.generated);

    // Spielerzahlen (einfach)
    let cur=null, max=null;
    if(live.players){
      cur = live.players.online ?? live.playersOnline ?? live.online;
      max = live.players.max ?? live.playersMax ?? live.max;
    } else {
      // Fallback: letzte bekannte aus players.json
      try{
        const arr = await fetchJSON(API_PLAYERS);
        const last = Array.isArray(arr)?arr[arr.length-1]:null;
        if(last){ cur = last.online ?? cur; max = last.max ?? max; }
      }catch{}
    }
    playersEl.textContent = (cur!=null && max!=null) ? `${cur} / ${max}` :
                            (cur!=null ? `${cur}` : '‚Äî');
  }catch{
    setLive(null,null);
    playersEl.textContent='‚Äî';
  }

  // History
  let data;
  try{ data=await loadHistory(range); }
  catch{ metaSrc.textContent='Quelle: History (Fehler)'; uptimeEl.textContent='‚Äî'; dtimeEl.textContent='‚Äî';
         kOnline.textContent='0'; kOffline.textContent='0'; kUnknown.textContent='0'; kPoints.textContent='0';
         incWrap.innerHTML='<h3>Incidents</h3><ul><li>History nicht erreichbar</li></ul>'; return; }

  const hist=Array.isArray(data.history)?data.history:[]; const generated=data.generated||new Date().toISOString();
  const svc=data.service||{}; $('svc-name').textContent=svc.name||'Minecraft Bedrock'; $('svc-host').textContent=[svc.host,svc.port].filter(Boolean).join(':');
  metaSrc.textContent='Quelle: History ‚úì';

  const intervals=toIntervals(hist,generated);

  // Uptime / Downtime + Render
  let uptime=0, downtimeMin=0, k;
  if(range==='24h'){
    const since=Date.now()-DAY_MS;
    const last24 = intervals.filter(i=>new Date(i.from).getTime()>=since);
    render24h(last24);
    k=kpisFromIntervals(last24);
    uptime = k.on / (k.on + k.off || 1);
    downtimeMin = k.off;
    await renderIncidents(last24);
  }else{
    const n = (range==='7d')?7:30;
    const days = aggregateByDays(intervals, n);   // exakt N Tage
    renderDays(days);
    const totalOn = days.reduce((a,b)=>a+b.on,0);
    const totalOff= days.reduce((a,b)=>a+b.off,0);
    const totalUnk= days.reduce((a,b)=>a+b.unk,0);
    uptime = totalOn / (totalOn + totalOff || 1);
    downtimeMin = totalOff;
    k = {on:totalOn, off:totalOff, unk:totalUnk, total:totalOn+totalOff+totalUnk, points:n};
    // Wartung trotzdem pr√ºfen, auch wenn keine Einzel-Events gelistet sind
    renderIncidents([]); // nur f√ºr Wartungsbadge unten
  }

  uptimeEl.textContent=fmtPct(uptime);
  dtimeEl.textContent=fmtDur(Math.round(downtimeMin));
  kOnline.textContent=Math.round(k.on/SLOT_MIN);
  kOffline.textContent=Math.round(k.off/SLOT_MIN);
  kUnknown.textContent=Math.round(k.unk/SLOT_MIN);
  kPoints.textContent=k.points;

  // Heatmap (Gesamt)
  if(hist.length){
    const totalDays = Math.max(1, Math.ceil((Date.now()-new Date(hist[0].ts).getTime())/DAY_MS)+1);
    const days90 = aggregateByDays(intervals, Math.min(90,totalDays));
    renderHeatmap(days90);
  } else {
    renderHeatmap([]);
  }
}

/* Heatmap */
function renderHeatmap(days){
  clear(heatEl);
  const last90 = days.slice(-90);
  last90.forEach(d=>{
    const c=document.createElement('div');
    c.className='cell '+(classifyDay(d));
    c.title=`${localDate(d.from)} ‚Äì on ${((d.on/d.total||0)*100).toFixed(1)}%, off ${((d.off/d.total||0)*100).toFixed(1)}%`;
    heatEl.appendChild(c);
  });
  const label=document.createElement('div'); label.className='label';
  if(last90.length){ label.textContent=`Zeitraum: ${localDate(last90[0].from)} ‚Äì ${localDate(last90[last90.length-1].from)}`; }
  else{ label.textContent='Keine Daten'; }
  heatEl.appendChild(label);
}

/* Range & Timer */
function onRangeChange(v){
  barsEl.classList.toggle('mode-24h',v==='24h');
  $('foot-left').textContent = v==='24h'?'24 hours':(v==='7d'?'7 days':'30 days');
  $('foot-right').textContent='Today';
  $('legend-interval').textContent = v==='24h' ? '1 Balken = 1 Probe (variable Minuten)' : '1 Balken = 1 Tag';
  const url=new URL(location.href); url.searchParams.set('range',v); history.replaceState(null,'',url.toString());
  load(v);
}
let timer=null;
function startTimer(){ stopTimer(); timer=setInterval(()=>{const v=rangeCtl.querySelector('input:checked')?.value||'24h'; load(v);},60_000); }
function stopTimer(){ if(timer){clearInterval(timer); timer=null;} }

setInitialFromParams();
rangeCtl.addEventListener('change', e=> onRangeChange(e.target.value));
autoCtl.addEventListener('change', e=>{
  const url=new URL(location.href); url.searchParams.set('live', e.target.checked?'1':'0'); history.replaceState(null,'',url.toString());
  e.target.checked?startTimer():stopTimer();
});
document.addEventListener('scroll', ()=>{TIP.style.display='none';}, true);
onRangeChange( (rangeCtl.querySelector('input:checked')?.value)||'24h' );
if(autoCtl.checked) startTimer();

/* Service Worker (harmlos, optional) */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}
</script>
</body>
</html>
